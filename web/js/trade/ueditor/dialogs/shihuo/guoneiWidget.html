<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>添加国内商品</title>
    <link rel="stylesheet" href="/simpleKindeditor/themes/default/default.css"/>
    <script src="/js/tradeadmin/lib/jquery1102.js" type="text/javascript"></script>
    <script src="/simpleKindeditor/kindeditor-min.js"></script>
    <script src="/simpleKindeditor/lang/zh_CN.js"></script>
    <style>
        .gwyy_btn_green {
            background-color: #5bb75b;
            background-image: linear-gradient(to bottom, #62c462, #51a351);
            background-repeat: repeat-x;
            border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
            color: #fff;
            text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body>

    <div>
        <div style="float: left;margin-right:10px;padding-top: 10px">
            <img id="showimg" src="/images/tradeadmin/global/placeholder.png" alt="" width="80" height="80"/>
        </div>

        <div tyle="float: left">
            <input value="" id="widget_url" style="width: 250px"/>   url <button type="button" id="getInfo" class=" gwyy_btn_green" style="float:right">抓取</button></br>
            <input value="" id="widget_title" style="width: 250px"/> 标题<br>
            <input value="" id="widget_price" style="width: 250px"/> 价格<br>
            <input value="" id="widget_from" style="width: 250px"/> 来自<br>
            <input value="" id="widget_img" style="width: 340px"/> 图片 <input type="button" id="infwidget_pic" value="选择文件" /><br>

        </div>
    </div>
    <script>
        if(parent.location.href.indexOf('_dev.php') != -1){
            var ajax_url = 'http://www.shihuo.cn/tradeadmin_dev.php/trd_special/getByZt6';
            var $uploadImagUrl = '/trade_dev.php/api/ueditorImageUpload?&rule=a%3A3%3A%7Bs%3A8%3A%22required%22%3Bb%3A1%3Bs%3A4%3A%22path%22%3Bs%3A11%3A%22youhuiIndex%22%3Bs%3A8%3A%22max_size%22%3Bs%3A7%3A%222000000%22%3B%7D';
        }else{
            var ajax_url = 'http://www.shihuo.cn/tradeadmin.php/trd_special/getByZt6';
            var $uploadImagUrl = '/trade.php/api/ueditorImageUpload?&rule=a%3A3%3A%7Bs%3A8%3A%22required%22%3Bb%3A1%3Bs%3A4%3A%22path%22%3Bs%3A11%3A%22youhuiIndex%22%3Bs%3A8%3A%22max_size%22%3Bs%3A7%3A%222000000%22%3B%7D';
        }

        KindEditor.ready(function(K) {
            var infwidget_pic = K.uploadbutton({
                button : K("#infwidget_pic")[0],
                fieldName : "imgFile",
                url : $uploadImagUrl,
                afterUpload : function(data) {
                    if (data.error === 0) {
                        callback(data.url)
                    } else {
                        alert(data.message);
                    }
                },
                afterError : function(str) {
                    alert("自定义错误信息: " + str);
                }
            });
            infwidget_pic.fileBox.change(function(e) {
                infwidget_pic.submit();
            });

        });


        function  callback(url){
           $('#widget_img').val(url+'?imageView2/1/w/200');
           $("#showimg").attr('src',url+'?imageView2/1/w/200');
        }

        //抓取
        $('#getInfo').click(function(){
            //如果不是站内 那么就是站外
            var tagurl = $("#widget_url").val();
            //判断是抓取站内 还是 站外
            if(tagurl == '') {
                alert('请输入URL！');
                return false;
            }
            var regexp = /tuangou|youhui|buy|^[0-9]+$/;
            if(!tagurl.match(regexp)){
                $.ajax({
                    url: "http://ruyi.taobao.com/ext/productLinkSearch?link=" + encodeURIComponent(tagurl) + "&group=prices,item&pid=rc001",
                    dataType: 'jsonp',
                    success: function (data) {
                        if($.isEmptyObject(data)){
                            alert('没有获取到对应的商品信息，请手动填写！');
                            return false;
                        }
                        var price = parseInt(data.Item.Price);
                        var image = data.Item.LargeImageUrl;
                        var title = data.Item.Title;
                        console.log(title);
                        var shop = data.Item.ShopName;
                        $("#widget_title").val(title);
                        $("#widget_from").val(shop);
                        $("#widget_price").val(price);
                        $("#widget_img").val(image);
                        if(image)$("#showimg").attr('src',image);
                    },error: function () {
                        alert('抓取失败，请联系开发人员。。。。');
                    }
                });
            }else{
                $.post(ajax_url ,{id:tagurl},function(msg){
                    if(msg.status) {
                        $("#widget_title").val(msg.info.title);
                        $("#widget_price").val(msg.info.price);
                        $("#widget_img").val(msg.info.image);
                        $("#widget_from").val(msg.info.store);
                        $("#widget_url").val(msg.info.url);
                        if(msg.info.image)$("#showimg").attr('src',msg.info.image);
                    } else {
                        alert(msg.info);
                    }
                },'json')
            }
        })
    </script>
</body>
</html>