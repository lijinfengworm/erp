$(function(){getDatas.init();addAddress.init();express.init();submit.init();$("#textatea-shuoming").focus(function(){$(this).val()==$(this).attr("data")&&$(this).val("").addClass("textareaColor")});$("#textatea-shuoming").blur(function(){$(this).val()==$(this).attr("data")||""==$.trim($(this).val())?($(this).val($(this).attr("data")).removeClass("textareaColor"),priceValue.remark=""):priceValue.remark=$(this).val()})});
var getDatas={init:function(){var a=this;a.obj=$(".goods-box");1==maxcount&&$(".select2").find(".jia").addClass("onColor");1==updateFlag?($(".style-select1,.style-select2").hide(),$.Jui._showMasks(0.5),$(".loding-box").css({left:$(".goods-box").offset().left+250,top:$(".goods-box").offset().top+20}).show(),$.post("http://www.shihuo.cn/haitao/updateProductInfo",{news_id:newsId,item_url:item_url},function(d){0==1*d.status&&(json_content=d.data,a.getDataFun(),a.bindFun());1==1*d.status&&(a.getDataFun(),
a.bindFun())},"json")):(a.getDataFun(),a.bindFun())},getDataFun:function(){var a=json_content,d=this,b,c=a.attr[0]?a.attr[0]:null,f=a.attr[1]?a.attr[1]:null;if(null!=c||null!=f)if(null!=f){this.jArray1={};this.jArray2={};for(var e=0;e<a[c].length;e++)for(var g=0;g<a.content.length;g++)a.content[g][c]==a[c][e]&&("undefined"==typeof this.jArray1[a[c][e]]?this.jArray1[a[c][e]]=[]:"",this.jArray1[a[c][e]].push(a.content[g]));for(e=0;e<a[f].length;e++)for(g=0;g<a.content.length;g++)a.content[g][f]==a[f][e]&&
("undefined"==typeof this.jArray2[a[f][e]]?this.jArray2[a[f][e]]=[]:"",this.jArray2[a[f][e]].push(a.content[g]));$(a[f]).each(function(e){$(d.jArray1[a[c][0]]).each(function(g){if(d.jArray1[a[c][0]][g][f]==a[f][e])return b=!0,d.getSelectB(d.jArray1[a[c][0]][g][f],a[c][0]),d.change2=d.jArray1[a[c][0]][g][f],!1});if(b)return!1});d.getSelectA(a[c][0])}else{g=[];for(e=0;e<a[c].length;e++)g.push('<option atr="'+a[c][e]+'">'+a[c][e]+"</option>");this.obj.find(".style-select1").html(g.join(""));priceValue.attr.key.push(a.attr[0]);
priceValue.attr.value.push(a[c][0]);$.Jui._closeMasks();$(".loding-box").hide();$(".style-select1,.style-select2").show()}else this.setHtml2(a.content[0])},getSelectA:function(a,d){for(var b=this,c=json_content,f=c.attr[0],e=c.attr[1],g=[],k,h=0;h<c[e].length;h++){for(var j=0;j<b.jArray1[a].length;j++)if(b.jArray1[a][j][e]==c[e][h]){var l=!0;break}else l=!1;l?g.push('<option atr="'+c[e][h]+'">'+c[e][h]+"</option>"):g.push('<option atr="'+c[e][h]+'" class="color-1">'+c[e][h]+"</option>")}b.obj.find(".style-select2").html(g.join(""));
void 0==d&&$(b.jArray2[b.change2]).each(function(a){if(b.jArray2[b.change2][a][f]==b.change1)return k=!0,!1});var i=d?d:b.jArray1[a][0][e];b.obj.find(".style-select2").each(function(){for(var a=0;a<this.options.length;a++)if(k)$(this).find("option").eq(a).attr("atr")==b.change2&&(i=this.options[a].selected=b.change2);else if(d){if($(this).find("option").eq(a).attr("atr")==i){this.options[a].selected=i;break}}else if(!$(this).find("option").eq(a).hasClass("color-1")){this.options[a].selected=$(this).find("option").eq(a).attr("atr");
break}b.change2=i})},getSelectB:function(a,d){for(var b=this,c=json_content,f=c.attr[0],e=c.attr[1],g=[],k,h=0;h<c[f].length;h++){for(var j=0;j<b.jArray2[a].length;j++)if(b.jArray2[a][j][f]==c[f][h]){var l=!0;break}else l=!1;l?g.push('<option atr="'+c[f][h]+'">'+c[f][h]+"</option>"):g.push('<option atr="'+c[f][h]+'" class="color-1">'+c[f][h]+"</option>")}b.obj.find(".style-select1").html(g.join(""));void 0==d&&$(b.jArray1[b.change1]).each(function(a){if(b.jArray1[b.change1][a][e]==b.change2)return k=
!0,!1});var i=d?d:b.jArray2[a][0][f];b.obj.find(".style-select1").each(function(){for(var a=0;a<this.options.length;a++)if(k)$(this).find("option").eq(a).attr("atr")==b.change1&&(i=this.options[a].selected=b.change1);else if(d){if($(this).find("option").eq(a).attr("atr")==i){this.options[a].selected=i;break}}else if(!$(this).find("option").eq(a).hasClass("color-1")){i=$(this).find("option").eq(a).attr("atr");this.options[a].selected=i;break}b.change1=i});setTimeout(function(){var a=b.obj.find(".style-select2").find("option:selected").text();
$(b.jArray2[a]).each(function(c){if(b.jArray2[a][c][f]==i)return b.setHtml(b.jArray2[a][c]),!1})},30)},setHtml:function(a){this.obj.find(".num").html();var d=json_content;this.obj.find(".imgs").find("img").attr("src",a.img);priceValue.attr.key=[];priceValue.attr.value=[];for(var b=0;b<d.attr.length;b++)priceValue.attr.key.push(d.attr[b]),priceValue.attr.value.push(a[d.attr[b]]);getPrice.getJson(function(a){$(".good-price").html(a.data.price);$(".good-all-price").html(a.data.product_total)});$.Jui._closeMasks();
$(".loding-box").hide();$(".style-select1,.style-select2").show()},setHtml2:function(a){this.obj.find(".imgs").find("img").attr("src",a.img);getPrice.getJson(function(a){$(".good-price").html(a.data.price);$(".good-all-price").html(a.data.product_total)});$.Jui._closeMasks();$(".loding-box").hide();$(".style-select1,.style-select2").show()},bindFun:function(){var a=$(".style-select1"),d=$(".style-select2"),b=$(".select2"),c=this,f=json_content,e=f.attr[0]?f.attr[0]:null,g=f.attr[1]?f.attr[1]:null;
if(null!=e||null!=g)null!=g?(a.live("change",function(){var a=$(this).val();c.change1=a;c.getSelectA(a);setTimeout(function(){c.getSelectB(c.change2,a)},30)}),d.live("change",function(){var a=$(this).val();c.change2=a;c.getSelectB(a);setTimeout(function(){c.getSelectA(c.change1,a)},30)})):a.live("change",function(){for(var a=$(this).val(),b=0;b<f.content.length;b++)if(f.content[b][e]==a)return c.setHtml(f.content[b]),!1});b.find(".jian").click(function(){var a=1*b.find(".num").html();if($(this).hasClass("onColor"))return!1;
1==a-1&&$(this).addClass("onColor");b.find(".jia").removeClass("onColor");b.find(".num").html(a-1);priceValue.number=a-1;getPrice.getJson(function(a){$(".good-price").html(a.data.price);$(".good-all-price").html(a.data.product_total)})});b.find(".jia").click(function(){var a=1*b.find(".num").html();if($(this).hasClass("onColor"))return!1;a+1==maxcount&&$(this).addClass("onColor");b.find(".jian").removeClass("onColor");b.find(".num").html(a+1);priceValue.number=a+1;getPrice.getJson(function(a){$(".good-price").html(a.data.price);
$(".good-all-price").html(a.data.product_total)})})}},addAddress={Verification:{name:!1,phone:!1,tell:!1,detailed:!1,postal:!1},init:function(){this.bindFun();this.cityAdd()},bindFun:function(){function a(){var a=$("input[name='phonesection']").data("check"),b=$("input[name='phonecode']").data("check"),c=$("input[name='phoneext']").data("check");e.Verification.tell=a&&b?!1==c?!1:!0:!1}var d=/^1[34578][0-9]{9}$/,b=/^[0-9]{3,6}$/,c=/^[0-9]{5,10}$/,f=/^[0-9]{0,5}$/,e=this;$("input[name='name']").blur(function(){var a=
$(this).val();""==$.trim(a)?$(this).tips("请填写姓名",{left:$(this).offset().left+$(this).outerWidth()+10,top:$(this).offset().top}):e.Verification.name=!0});$("input[name='phone']").blur(function(){var a=$(this).val();d.test(a)?e.Verification.phone=!0:$(this).tips("请填写正确的手机号码",{left:$(this).offset().left+$(this).outerWidth()+10,top:$(this).offset().top})});$("input[name='phonesection']").blur(function(){var c=$(this).val();!b.test(c)&&""!=$.trim(c)?($(this).tips("区号必须为3到6位数字",{left:$(this).offset().left+
$(this).outerWidth()+10,top:$(this).offset().top}),$(this).data("check",!1)):$(this).data("check",!0);a()});$("input[name='phonecode']").blur(function(){var b=$(this).val();!c.test(b)&&""!=$.trim(b)?($(this).tips("电话必须为5到10位数字",{left:$(this).offset().left+$(this).outerWidth()+10,top:$(this).offset().top}),$(this).data("check",!1)):$(this).data("check",!0);a()});$("input[name='phoneext']").blur(function(){var b=$(this).val();!f.test(b)&&""!=$.trim(b)?($(this).tips("电话分机必须少于6个数字",{left:$(this).offset().left+
$(this).outerWidth()+10,top:$(this).offset().top}),$(this).data("check",!1)):$(this).data("check",!0);a()});$("input[name='detailed']").blur(function(){var a=$(this).val();""==$.trim(a)?$(this).tips("请填写详细地址",{left:$(this).offset().left+$(this).outerWidth()+10,top:$(this).offset().top}):e.Verification.detailed=!0});$("input[name='postal']").blur(function(){var a=$(this).val();""==$.trim(a)?$(this).tips("请填写邮政编码",{left:$(this).offset().left+$(this).outerWidth()+10,top:$(this).offset().top}):e.Verification.postal=
!0});$("input[name='address']").change(function(){priceValue.address_id=1*$(this).val();getPrice.getJson()});$(".address-ul").find(".save").click(function(){var a=$(this),b=$("input[name='name']").val(),c=$("input[name='phone']").val(),d=$("input[name='phonesection']").val(),f=$("input[name='phonecode']").val(),i=$("input[name='phoneext']").val(),m=$(".sel-1").val(),n=$(".sel-2").val(),o=$(".sel-3").val(),p=$("input[name='detailed']").val(),q=$("input[name='postal']").val();defaultflagVal="checked"==
$("input[name='defaultflag']").attr("checked")?1:0;if(!e.Verification.name)return $("input[name='name']").blur(),!1;if(!e.Verification.phone)return $("input[name='phone']").blur(),!1;if(""!=$.trim($("input[name='phonesection']").val())&&(""!=$.trim($("input[name='phonecode']").val())&&""!=$.trim($("input[name='phoneext']").val()))&&!e.Verification.tell)return $("input[name='phonecode']").tips("请正确填写电话号码",{left:$("input[name='phonecode']").offset().left+$(this).outerWidth()+10,top:$("input[name='phonecode']").offset().top}),
!1;if(!e.Verification.detailed)return $("input[name='detailed']").blur(),!1;if(!e.Verification.postal)return $("input[name='postal']").blur(),!1;$.get("http://www.shihuo.cn/haitao/saveDeliveryAddress",{name:b,mobile:c,phonesection:d,phonecode:f,phoneext:i,province:m,city:n,area:o,street:p,postcode:q,defaultflag:defaultflagVal},function(b){1==1*b.status?a.tips(b.msg):($(".default_address").prepend('<p><label><input name="address" type="radio" value="'+b.data.id+'" /> '+b.data.address+"</label></p>"),
$("input[name='address']").eq(0).attr("checked","checked"),priceValue.address_id=1*$("input[name='address']:checked").val(),$(".address-ul").hide(),getPrice.getJson(),e.clearAddress())},"json")});$(".add_new_address").change(function(){$(".address-ul").show()})},clearAddress:function(){$("input[name='name']").val("");$("input[name='phone']").val("");$("input[name='phonesection']").val("");$("input[name='phonecode']").val("");$("input[name='phoneext']").val("");$("input[name='detailed']").val("");
$("input[name='postal']").val("");$("input[name='defaultflag']").removeAttr("checked")},cityAdd:function(){var a=$(".select_city"),d=this;a.find(".sel-1").change(function(){var a=$(this).val();$(".select_city").find(".sel-2").html('<option value="0">请选择</option>');$(".select_city").find(".sel-3").html('<option value="0">请选择</option>');$.get("http://www.shihuo.cn/haitao/getRegionByRegionId?region_id="+a,function(a){d.cityAddstr(a,$(".select_city").find(".sel-2"))},"json")});a.find(".sel-2").change(function(){var a=
$(this).val();$.get("http://www.shihuo.cn/haitao/getRegionByRegionId?region_id="+a,function(a){d.cityAddstr(a,$(".select_city").find(".sel-3"))},"json")})},cityAddstr:function(a,d){for(var b=[],c=0,f=a.data.length;c<f;c++)b.push('<option value="'+a.data[c].region_id+'">'+a.data[c].region_name+"</option>"),b.join("");d.append(b)}},express={init:function(){$("input[name='kuaidi']").change(function(){priceValue.type=1*$("input[name='kuaidi']:checked").val();getPrice.getJson()})}},priceValue={newsId:newsId,
address_id:1*$("input[name='address']:checked").val(),type:1*$("input[name='kuaidi']:checked").val(),number:1,remark:"",attr:{key:[],value:[]}},getPrice={init:function(){},getJson:function(a){var d=$(".submit-box"),b;$.post("http://www.shihuo.cn/haitao/getOrderTotalPrice",{news_id:priceValue.newsId,address_id:priceValue.address_id,type:priceValue.type,number:priceValue.number,remark:priceValue.remark,attr:priceValue.attr},function(c){b='<span class="m1">商家：<s>'+c.data.mart+'</s></span><span class="m1">商家价格：<s>'+
c.data.product_total+'RMB</s></span><span class="m1">国际运费：<s>'+c.data.intl_fee+'RMB</s></span><span class="m1">国内运费：<s>'+c.data.fee+'RMB</s></span>                       <div class="all-price clearfix">                           '+(1==flag?'<div class="pr1">黑五活动，立减10元</div>':"")+'                           <div class="pr2">                              总计：<s><i>'+c.data.total_price+"</i>RMB</s>                          </div>                       </div>";d.find(".message-all").html(b);a&&a(c)},"json")}},
submit={ajaxLoding:!1,init:function(){this.bindFun()},bindFun:function(){var a=this;if(a.ajaxLoding)return!1;a.ajaxLoding=!0;$(".submit-btn").click(function(){var d=$(this);d.addClass("submit-btnCC");$.post("http://www.shihuo.cn/haitao/submitOrder",{news_id:priceValue.newsId,address_id:priceValue.address_id,type:priceValue.type,number:priceValue.number,remark:priceValue.remark,attr:priceValue.attr},function(b){0==b.status?window.location.href=b.data.url:(d.removeClass("submit-btnCC"),d.tips(b.msg));
a.ajaxLoding=!1},"json")})}};
!function(a){a.Jui=a.Jui||{};a.extend(a.Jui,{_$:function(a,b){a.siblings().removeClass(b);a.addClass(b)},_showMasks:function(d){var b="<div class='body-mask' style='position:absolute; top:0; left:0; width:100%; height:"+a(document).height()+"px; background-color:#000;  z-index:91;'></div>";a("body").append(b);a(".body-mask").css("opacity",0);a(".body-mask").animate({opacity:d?d:"0.8"})},_closeMasks:function(){var d=a(".body-mask");d.fadeOut(function(){d.remove()})},_getpageSize:function(){var a=document.documentElement;
return[window.innerWidth||self.innerWidth||a&&a.clientWidth||document.body.clientWidth,window.innerHeight||self.innerHeight||a&&a.clientHeight||document.body.clientHeight]},_getpageScroll:function(){var a;self.pageYOffset?a=self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?a=document.documentElement.scrollTop:document.body&&(a=document.body.scrollTop);return a},isie:!!a.browser.msie,isie6:!!a.browser.msie&&6>=parseInt(a.browser.version),DOC:a(document),WIN:a(window),HEAD:a(document).find("head"),
BODY:a(document).find("body")});a.fn.tips=function(d,b){return this.each(function(){var c=a(this),f='<div class="tips_layer" style="position: absolute; border-radius:5px; background-color:#ff6600; display:none; z-index:995">                <div class="tips-text" style="padding:2px 5px; line-height:18px; color:#fff;">'+d+'</div>                <div class="diamond"></div>            </div>';a(".tips_layer")&&a(".tips_layer").remove();a(f).appendTo("body");a(".tips-text");var e=a(".tips_layer");b?e.css({top:b.top,
left:b.left}).show():e.css({top:c.offset().top-parseInt(c.height())-10,left:c.offset().left+parseInt(c.width()/2)-30}).show();setTimeout(function(){e.remove()},2E3)})}}(jQuery);
