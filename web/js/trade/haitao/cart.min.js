$(function(){cartJsong.init();if($(document).height()>800){$(".go-buy").addClass("fixed-post").css({left:$(".shihuo-content-wrap").offset().left}).show()}});var cartJsong={changeFlag:true,updataLength:null,submitUp:false,updataListNum:0,goodCheck:[],goodList:[],goodGid:null,init:function(){this.updataLength=updateList.length;this.upLoding();this.bindFun()},upLoding:function(){var a=this;if(this.updataLength-1>=this.updataListNum){$(".shops-goods-id-"+updateList[this.updataListNum].data.goods_id).find(".price").hide();$(".shops-goods-id-"+updateList[this.updataListNum].data.goods_id).find(".loding-js").show();$.post("http://www.shihuo.cn/haitao/cartUpdateProductInfo",{data:updateList[this.updataListNum].data,productId:updateList[this.updataListNum].productId},function(b){if(b.status*1==0){$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".price p").eq(0).html("金额：￥"+b.data.price);$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".price").show();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".loding-js").hide();if(typeof(b.data.weight)&&b.data.weight!=""){}else{$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".price p:last").html('<font color="red">没有获取到运费，请联系客服修改</font>');$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).attr("choose","true")}if(b.data.flag){$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".price .change s").html(b.data.change);$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".price .change").show()}else{$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".price .change").hide()}if(b.data.status){$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).addClass("shixiao-class");$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t1 input").attr("disabled","disabled").hide();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t1 .shixiao").show();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t3 .n1").hide();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t3 .n2").show()}else{$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).removeClass("shixiao-class");$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t1 input").removeAttr("disabled").show();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t1 .shixiao").hide();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t3 .n1").show();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".t3 .n2").hide()}}else{$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".price").show();$(".shops-goods-id-"+updateList[a.updataListNum].data.goods_id).find(".loding-js").hide()}a.updataListNum++;a.upLoding()},"json")}else{a.changeFlag=false}},bindFun:function(){var a=this;$(".shihuo-content-wrap input").click(function(){if(a.changeFlag||$(this).parents("li").attr("choose")=="true"){return false}});$(".check_all").change(function(){var b=$(this).attr("checked");if(b=="checked"){$("input[name='check-shop']").attr("checked","checked");$("input[name='check-all']").attr("checked","checked");$("input[name='check-goods']").each(function(){if($(this).parents("li").attr("choose")=="true"){$(this).attr("checked",false);$(this).parents("li").removeClass("select")}else{$(this).attr("checked","checked");$(this).parents("li").addClass("select")}})}else{$("input[name='check-shop']").attr("checked",false);$("input[name='check-goods']").attr("checked",false);$("input[name='check-all']").attr("checked",false)}a.getGoodsIdPost()});$("input[name='check-shop']").change(function(){var b=$(this).attr("checked");if(b=="checked"){$(this).parents(".good-from").find("input[name='check-goods']").each(function(){if($(this).parents("li").attr("choose")=="true"){$(this).attr("checked",false);$(this).parents("li").removeClass("select")}else{$(this).attr("checked","checked");$(this).parents("li").addClass("select")}})}else{$(this).parents(".good-from").find("input[name='check-goods']").attr("checked",false)}a.checkAllFun();a.getGoodsIdPost()});$("input[name='check-goods']").change(function(){var b=true;$(this).parents(".goods-list").find("input[name='check-goods']").each(function(c,e){if(!e.checked){b=false}});if(b){$(this).parents(".good-from").find("input[name='check-shop']").attr("checked","checked")}else{$(this).parents(".good-from").find("input[name='check-shop']").attr("checked",false)}a.checkAllFun();a.getGoodsIdPost()});$(".goods-add-btn").find(".a1").click(function(){if(a.changeFlag||$(this).parents("li").attr("choose")=="true"){return false}var c=$(this).next(),b=$(this).parents(".goods-add-btn").attr("gid"),d=c.html()*1;if(d>1){c.html(--d);a.addGoods({goods_id:b,type:0},$(this).parents(".goods-add-btn").next());$(".goods-add-btn").find(".a3").removeClass("bgs");if(d==1){$(this).addClass("bgs")}if(d<=c.attr("max")){$(this).parent().find(".maxnumtips").hide()}else{$(this).parent().find(".maxnumtips").show()}}});$(".goods-add-btn").find(".a3").click(function(){if(a.changeFlag||$(this).parents("li").attr("choose")=="true"){return false}var d=$(this).prev(),b=$(this).parents(".goods-add-btn").attr("gid"),e=d.attr("max")*1,c=d.html()*1;if(c<e){d.html(++c);a.addGoods({goods_id:b,type:1},$(this).parents(".goods-add-btn").next());$(".goods-add-btn").find(".a1").removeClass("bgs");$(this).next().hide();if(c>=e){$(this).addClass("bgs");$(this).next().show().find(".tips-text").text("限购 "+e+" 件")}}});$("#delete_id").click(function(){a.deleteConfirm(a.goodCheck)});$(".good-from .delete").click(function(){a.goodGid=$(this).attr("gid");a.deleteConfirm([a.goodGid])});$(".write-card i,.write-card .btn2").live("click",function(){$.Jui._closeMasks();$(".write-card").remove()});$(".write-card .btn1").live("click",function(){$.Jui._closeMasks();a.deleteGoods($(".write-card").data("gid"));$(".write-card").remove()});$("#submit-all,#submit-all2").click(function(){if(a.goodList.length>0){a.fromSubmit()}else{alert("请勾选商品")}return false})},checkAllFun:function(){var a=false;$("input[name='check-goods']").each(function(b,c){if(!c.checked){a=true;return false}});if(a){$("input[name='check-all']").attr("checked",false)}else{$("input[name='check-all']").attr("checked","checked")}},getGoodsIdPost:function(){var a=this;a.goodCheck=[];a.goodList=[];$("input[name='check-goods']:enabled").each(function(b,c){if(c.checked){a.goodCheck.push(c.getAttribute("gid"));a.goodList.push(c.getAttribute("gilist"));$(this).parents("li").addClass("select")}else{$(this).parents("li").removeClass("select")}});$(".activity-grid").attr("data-onactivity","0");$.post("http://www.shihuo.cn/haitao/getCartAllPrice",{data:a.goodCheck},function(g){if(g.status*1==0){var d=g.data;var b=[d.total_product_price,d.total_product_freight,d.total_count,d.total_price,d.save_freight,d.original_total_price||0,d.usa_freight||0];for(var f=0;f<=b.length;f++){$(".price-id-"+(f+1)).html((f==2?b[f]:"￥"+b[f]))}$(".activity-info li").removeClass("on");$(".activity-grid span").removeClass("on");$(".activity-salebox").hide();if("undefined"!=typeof d.activity){d.activity.activity_save==0?$(".activity-salebox").hide():($("#activity-sale").html("￥"+d.activity.activity_save),$(".activity-salebox").show());var l=d.activity.activity,m=d.activity.goods_info;for(var f in l){var h=f-1,e=$("ul",".activity-info:eq("+h+")");for(var n=0;n<l[f].list.length;n++){var k=$(".activity-info:eq("+h+")").find("#market_"+l[f].list[n].id);if(l[f].list[n].flag==true){k.addClass("on").find("a:eq(0)").attr({href:"javascript:void(0)",target:"_self"});k.find(".link").attr({href:"javascript:void(0)",target:"_self"}).hide()}else{k.removeClass("on").find("a:eq(0)").attr({href:k.find("a:eq(0)").attr("more-url"),target:"_blank"});k.find(".link").attr({href:k.find("a:eq(0)").attr("more-url"),target:"_blank"}).show()}}}for(var f in m){var j=m[f].goods_id,c=$(".shops-goods-id-"+j+" .activity-grid");c.attr("data-onactivity","1");if(!m[f].collectFlag){c.find("a:last-child").hide()}else{c.find("a:last-child").show()}for(var n=0;n<m[f].activity.length;n++){if(m[f].activity[n].platformFlag==true||m[f].activity[n].shihuoFlag==true){$(".shops-goods-id-"+j+" .activity-grid").find("a").eq(n).attr({href:"javascript:void(0)",target:"_self"}).addClass("on")}else{if((m[f].activity[n].platformFlag==false&&"undefined"==typeof m[f].activity[n].shihuoFlag)||(m[f].activity[n].shihuoFlag==false&&"undefined"==typeof m[f].activity[n].platformFlag)||(m[f].activity[n].shihuoFlag==false&&m[f].activity[n].platformFlag==false)||("undefined"==typeof m[f].activity[n].platformFlag&&"undefined"==typeof m[f].activity[n].shihuoFlag)){$(".shops-goods-id-"+j+" .activity-grid").find("a").eq(n).attr({href:$(".shops-goods-id-"+j+" .activity-grid").attr("more-url"),target:"_blank"}).removeClass("on")}}}}$(".activity-grid").each(function(){if($(this).attr("data-onactivity")==0){$("a",this).each(function(){$(this).attr("more-url")?$(this).removeClass("on").attr({href:$(this).attr("more-url"),target:"_blank"}).show():$(this).show()})}})}else{$(".activity-info li").each(function(){$(this).removeClass("on").find("a").attr({href:$(this).find("a").attr("more-url"),target:"_blank"}).show()});$(".activity-grid a").each(function(){$(this).attr("more-url")?$(this).removeClass("on").attr({href:$(this).attr("more-url"),target:"_blank"}).show():$(this).show()})}}else{alert(g.msg)}},"json")},sortArray:function(){},addGoods:function(a,c){var b=this;$.post("http://www.shihuo.cn/haitao/addCartNumber",a,function(d){if(d.status*1==0){c.find("p").eq(0).html("金额：￥"+d.data.total_price);b.getGoodsIdPost()}},"json")},deleteConfirm:function(a){var b='<div class="write-card">                  <div class="title"><i></i>提示</div>                  <div class="inner">                      <div class="inner-html clearfix">                           <div class="left">                              <img src="/images/trade/ucenter/gt.jpg" />                           </div>                           <div class="right">                              <div class="h2">删除商品?</div>                              <div class="btn-span">                                  <span class="btn1">确定</span><span class="btn2">取消</span>                              </div>                           </div>                      </div>                  </div>              </div>';$.Jui._showMasks(0.6);$(b).appendTo("body");$(".write-card").css({left:$.Jui._position($(".write-card"))[0],top:$.Jui._position($(".write-card"))[1]-$.Jui._getpageScroll()}).show();$(".write-card").data("gid",a)},deleteGoods:function(a){var b=this;$.post("http://www.shihuo.cn/haitao/deleteCart",{data:a},function(e){if(e.status*1==0){$("#cart_num").html(e.data);for(var d=0;d<a.length;d++){var c=$(".shops-goods-id-"+a[d]).parents(".good-from");if(c.find("li").length==1){c.remove()}else{$(".shops-goods-id-"+a[d]).remove()}if($(".good-from").find("li").length<1){location.reload()}}b.getGoodsIdPost();$("#cart-right-area .goods-num").html(e.data);$("#cart_num_nva").html(e.data)}},"json")},fromSubmit:function(){var b="";if(this.submitUp){return false}this.submitUp=true;$("#submit-all").addClass("input-false");$("#submit-all").val("提交中...");for(var a=0;a<this.goodList.length;a++){b+=(a==0?"":",")+this.goodList[a]}$("#goods-form").html('<input type="hidden" value="'+b+'" name="data" />');$("#goods-form").submit()}};!(function(b){function a(d,c){return this.each(function(){var g=b(this),h='<div class="tips_layer" style="position: absolute; border-radius:5px; background-color:#ff6600; display:none; z-index:995">                <div class="tips-text" style="padding:2px 5px; line-height:18px; color:#fff;">'+d+'</div>                <div class="diamond"></div>            </div>';if(b(".tips_layer")){b(".tips_layer").remove()}b(h).appendTo("body");var e=b(".tips-text"),f=b(".tips_layer");if(c){f.css({top:c.top,left:c.left}).show()}else{f.css({top:g.offset().top-parseInt(g.height())-10,left:g.offset().left+parseInt(g.width()/2)-30}).show()}setTimeout(function(){f.remove()},2000)})}b.Jui=b.Jui||{};b.extend(b.Jui,{_$:function(d,c){d.siblings().removeClass(c);d.addClass(c)},_showMasks:function(c){var d="<div class='body-mask' style='position:absolute; top:0; left:0; width:100%; height:"+b(document).height()+"px; background-color:#000;  z-index:91;'></div>";b("body").append(d);b(".body-mask").css("opacity",0);b(".body-mask").animate({opacity:c?c:"0.8"})},_closeMasks:function(){var c=b(".body-mask");c.fadeOut(function(){c.remove()})},_getpageSize:function(){var f=document.documentElement,d,c=window.innerWidth||self.innerWidth||(f&&f.clientWidth)||document.body.clientWidth,e=window.innerHeight||self.innerHeight||(f&&f.clientHeight)||document.body.clientHeight;d=[c,e];return d},_position:function(e){var d=((this._getpageSize()[0]-parseInt(e.outerWidth()))/2);var c=((this._getpageSize()[1]-parseInt(e.outerHeight()))/2)+b.Jui._getpageScroll();return[d,c]},_getpageScroll:function(){var c;if(self.pageYOffset){c=self.pageYOffset}else{if(document.documentElement&&document.documentElement.scrollTop){c=document.documentElement.scrollTop}else{if(document.body){c=document.body.scrollTop}}}return c},isie:!!b.browser.msie,isie6:(!!b.browser.msie&&parseInt(b.browser.version)<=6),DOC:b(document),WIN:b(window),HEAD:b(document).find("head"),BODY:b(document).find("body")});b.fn.tips=a})(jQuery);