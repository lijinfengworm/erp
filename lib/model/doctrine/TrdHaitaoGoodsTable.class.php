<?php

/**
 * TrdHaitaoGoodsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdHaitaoGoodsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TrdHaitaoGoodsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdHaitaoGoods');
    }
    
    //更新状态
    public static function updateStatusByProductId($product_id){
        if (!$product_id) return false;
        return self::getInstance()
                ->createQuery('t')
                ->update()
                ->set('t.status', 1)
                ->where('t.product_id = ?', $product_id)
                ->execute();
    }

    /*
     *sku 库存增减
     *array(1=>'下单成功',2=>'付款成功'，3=>'退款',4=>'未付款取消',5=>'退款取消')
     **/
    public static function setSkuStockById($id, $num, $type){
        $return = array();
        try {
            tradeCommon::getLock('shihuo.product.sku.stock'.$id, 5);//获取锁
            $sku =  self::getInstance()->find($id);
            if($sku){
                if (substr($sku->getGoodsId(),0,2) != 'cn'){
                    $return['status'] = true;
                    $return['num'] =  $sku->getTotalNum();
                    tradeCommon::releaseLock('shihuo.product.sku.stock'.$id);//释放锁
                }
                $sendMessFlag = false;//是否发送库存变更消息
                if($type == '1'){
                    $lockNum = (int)$sku->getLockNum() + $num;
                    $totalNum = (int)$sku->getTotalNum() - $num;
                    $sendMessFlag = true;
                }elseif($type == '2'){
                    $lockNum = (int)$sku->getLockNum() - $num;
                    $totalNum= (int)$sku->getTotalNum();
                }elseif($type == '3'){
                    $lockNum = (int)$sku->getLockNum();
                    $totalNum = (int)$sku->getTotalNum() + $num;
                    $sendMessFlag = true;
                }elseif($type == '4'){
                    $lockNum = (int)$sku->getLockNum() - $num;
                    $totalNum = (int)$sku->getTotalNum() + $num;
                    $sendMessFlag = true;
                }
                if ($sendMessFlag) tradeCommon::sendMqMessage('product.stock',array('product_id'=>$sku->getProductId()),'product_stock_deferred');
                $sku->setLockNum($lockNum);
                $sku->setTotalNum($totalNum);
                $sku->save();
            }
            tradeCommon::releaseLock('shihuo.product.sku.stock'.$id);//释放锁
            $return['status'] = true;
            $return['num'] =  $sku->getTotalNum();
        }catch(Exception $e) {
            $return['status'] = false;
            $return['message'] = $e->getMessage();
        }
        return $return;
    }

}