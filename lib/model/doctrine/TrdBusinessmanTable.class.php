<?php

/**
 * TrdBusinessmanTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdBusinessmanTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TrdBusinessmanTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdBusinessman');
    }
	public function getOneByHupuUid($uid)
	{
		return self::createQuery()->where('hupu_uid  = ?',$uid)->fetchOne();
	}

    public static function getShopByWanWan($wanwan)
    {
        return self::getInstance()->createQuery()
            ->where('wanwan = ?', $wanwan)
            ->addWhere('alliance = 1')
            ->count();
    }

    public static function houtaGetCount($search=array())
    {
        $query = self::getInstance()->createQuery();
        self::addFilterCondition($query,$search);
        return $query->count();
    }


    public static function houtaGetList($offset=0,$limit=20,$search=array())
    {
        $query = self::getInstance()->createQuery();
        self::addFilterCondition($query,$search);
        $query->orderBy('id desc')
            ->offset($offset)
            ->limit($limit);
        return $query->fetchArray();
    }

    public  static function addFilterCondition(Doctrine_Query $query = null,$search=array())
    {
        if(!empty($search['username']))
        {
            $query->andWhere('username like \'%'.$search['username'].'%\'');
        }
        if(!empty($search['hupu_uid']))
        {
            $query->andWhere('hupu_uid like \'%'.$search['hupu_uid'].'%\'');
        }
        if(!empty($search['hupu_username']))
        {
            $query->andWhere('hupu_username like \'%'.$search['hupu_username'].'%\'');
        }
        if(!empty($search['email']))
        {
            $query->andWhere('email like \'%'.$search['email'].'%\'');
        }
        if(!empty($search['shop_url']))
        {
            $query->andWhere('shop_url like \'%'.$search['shop_url'].'%\'');
        }
        if(!empty($search['phone']))
        {
            $query->andWhere('phone like \'%'.$search['phone'].'%\'');
        }
        if(!empty($search['qq']))
        {
            $query->andWhere('qq like \'%'.$search['qq'].'%\'');
        }
        if(!empty($search['shop_name']))
        {
            $query->andWhere('shop_name like \'%'.$search['shop_name'].'%\'');
        }
        return $query;
    }

    # 商家积分格式转换
    public static function creditFormat($price=0)
    {
        if(!$price) return 0;
        return $price/100;
    }

    public static function getShopName($uid)
    {
        if($uid){
            return self::getInstance()
                ->createQuery()
                ->setResultCacheHash('trade:memcache:groupon:shop:name:'.$uid)
                ->setResultCacheLifeSpan( 60*10 )
                ->useResultCache()
                ->where('hupu_uid  = ?', $uid)
                ->fetchOne()
                ->getShopName();
        }else{
            return '';
        }
    }

    public static function getShopInfo($uid)
    {
        if($uid){
            return self::getInstance()
                ->createQuery()
                ->setResultCacheHash('trade:memcache:groupon:shop:info3:'.$uid)
                ->setResultCacheLifeSpan( 60*10 )
                ->useResultCache()
                ->where('hupu_uid  = ?', $uid)
                ->fetchOne()
                ->toArray();
        }else{
            return '';
        }
    }
}