<?php

/**
 * TrdGoodsSupplierComment
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    HC
 * @subpackage model
 * @author     HoopChina.com Dev Team
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class TrdGoodsSupplierComment extends BaseTrdGoodsSupplierComment
{
    public static $_status = array(
        0 => '待审核',
        1 => '审核通过',
        2 => '未通过',
        3 =>'不展示'
    );

    public static $_type = array(
        0=>'普通评论',
        1=>'晒物评论'
    );

    public function preUpdate($event)
    {
        $new = $this->getModified();
        $modified = array_keys($new);

        $updateFields = array('status');
        if(array_intersect($updateFields,$modified)){
            self::updateGoodsCommentNum($this->goods_id, $this->status);
        }

        parent::preUpdate($event);
    }

    /*
     *修改商品有效评论数
     **/
    public static function updateGoodsCommentNum($goods_id, $status = null){
        $c = TrdGoodsSupplierCommentTable::getInstance()->createQuery()
            ->where('goods_id = ?', $goods_id)
            ->andWhere('status = ?',1)
            ->count();

        //本条
        if($status !== null){
            if($status == 1){
                $c+=1;
            }else{
                $c-=1;
            }
        }


        //保存
        $g = trdGoodsTable::getInstance()->find($goods_id);
        if($g){
            $g->setComment($c);
            $g->save();
        }
    }

    public function getImgs(){
        if($this->img_attr)
            return json_decode($this->img_attr, true);
        else
            return array();
    }
}
