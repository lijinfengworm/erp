<?php

/**
 * KllActivityTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class KllActivityTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object KllActivityTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('KllActivity');
    }


    public static function houtaGetActivity($offset = 0, $limit = 15)
    {
        $now = time();
        $connection = Doctrine_Manager::getInstance()->getConnection('kaluli');
        $connection->execute("set time_zone = '+8:00';");
        $query = "SELECT *,
                    (case
                    when UNIX_TIMESTAMP(start_date)<= {$now} and UNIX_TIMESTAMP(expiry_date)> {$now} then 0
                    when {$now}< UNIX_TIMESTAMP(start_date) then 1
                    when {$now}>= UNIX_TIMESTAMP(expiry_date) then 2
                    else 4 end) as status
                    from kll_activity ORDER BY status ASC,created_at desc limit {$offset}, {$limit} ";
        $statement = $connection->execute($query);
        $statement->execute();
        $resultset = $statement->fetchAll(PDO::FETCH_ASSOC);
        return $resultset;
    }

    public static function houtaGetActivityCount()
    {
        $query = self::getInstance()->createQuery()
            ->orderBy('id desc');
        return $query->count();
    }


    public static function getActivity($page = 1, $limit = 20, $type = null)
    {
        $offset = ($page - 1) * $limit;
        $date_now = date('Y-m-d H:i:s');
        if ('hot' == $type) {
            $query = self::getInstance()->createQuery()
                ->select('id,total,recevied,title,recevied/total as rate,img_path,start_date,expiry_date')
                ->where('is_delete = ?', 0)
                ->andWhere('expiry_date > ?', $date_now)
                ->andWhere('start_date < ?', $date_now)
                ->offset($offset)
                ->limit($limit)
                ->orderBy('rate desc');
        } else {
            $query = self::getInstance()->createQuery()
                ->select('id,title,total,recevied,img_path,start_date,expiry_date')
                ->where('is_delete = ?', 0)
                ->andWhere('expiry_date > ?', $date_now)
                ->andWhere('start_date < ?', $date_now)
                ->offset($offset)
                ->limit($limit)
                ->orderBy('id desc');
        }

        return $query->fetchArray();

    }


    public static function getActivitys($ids=array())
    {
        if(!$ids) return false;
        $data = CacheModel::getCache();
        if(empty($data))
        {
            $date_now = date('Y-m-d H:i:s');
            $data = self::getInstance()->createQuery()
                ->whereIn('id',$ids)
                ->select('id')
                ->andWhere('is_delete = ?', 0)
                ->andWhere('expiry_date > ?', $date_now)
                ->andWhere('start_date < ?', $date_now)
                ->orderBy("FIELD(`ID`,".trim(join(",", $ids)) . ')')
                ->limit(5)
                ->fetchArray();
            CacheModel::setCache($data,600);
        }
        return $data;
    }
}