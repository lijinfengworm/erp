<?php

/**
 * TrdHaitaoCurrencyExchange
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class TrdHaitaoCurrencyExchange extends BaseTrdHaitaoCurrencyExchange
{

    public function getRateStr()
    {
        return "1" . $this->getCurrencyName($this->getCurrencyFrom()) . '=' . $this->getExchangeRate() . $this->getCurrencyName($this->getCurrencyTo());
    }

    private function getCurrencyName($currency)
    {
        $currencyNames = array(
            0 => '美元',
            1 => '人民币',
            2 => '欧元',
            3 => '英镑',
            4 => '日元',
            5 => '港元'
        );
        if (isset($currencyNames[$currency]))
            return $currencyNames[$currency];
        else
            return '未知币种';
    }

    public function save(Doctrine_Connection $conn = null)
    {
        $flag = false;
        if ($this->isNew()) {
            $f = (int)$this->getCurrencyFrom();
            $t = (int)$this->getCurrencyTo();
            $flag = true;
        }
        if ($this->isModified()) {
            $v = $this->getModified();
            if (isset($v['currency_from']) && !empty($v['currency_from'])){
                $f = $v['currency_from'];
                $flag = true;
            }else{
                $f = (int)$this->getCurrencyFrom();
            }
            if (isset($v['currency_to']) && !empty($v['currency_to'])){
                $t = $v['currency_to'];
                $flag = true;
            }else{
                $t = (int)$this->getCurrencyTo();
            }
        }

        if (isset($f) && isset($t) && $flag) {
            $q = Doctrine_Core::getTable('TrdHaitaoCurrencyExchange')
                ->createQuery('j')
                ->where('j.currency_from = ?', $f)
                ->andWhere('j.currency_to = ?', $t);
            if ($q->count()) {
                sfContext::getInstance()->getUser()->setFlash('notice', '对不起，您刚才的设置未生效您。因为输入的汇率关系已经存在，请重新修改。');
                sfContext::getInstance()->getController()->redirect('trd_haitao_currency_exchange');
                exit;
            } else {
                parent::save($conn);
            }
        }
        parent::save($conn);
    }


}
