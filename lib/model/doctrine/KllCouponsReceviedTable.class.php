<?php

/**
 * KllCouponsReceviedTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class KllCouponsReceviedTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object KllCouponsReceviedTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('KllCouponsRecevied');
    }

    # 查看已领取的总数
    public static function getReceiveCount($activity_id=null,$type=0)
    {
        if(empty($activity_id)) return false;

        $query =  self::getInstance()->createQuery()
            ->where('activity_id = ?',$activity_id);
        if( $type == 1 )
        {
            $query->andWhere('status = ?',1);
        }
        return $query->count();
    }

    # 查看已领取的列表
    public static function getReceiveList($activity_id=null,$offset=0,$limit=30,$type=0)
    {
        if(empty($activity_id)) return false;
        $query = self::getInstance()->createQuery()
            ->where('activity_id = ?',$activity_id);
        $query->whereIn('status',array(1,2));
        return $query->offset($offset)
            ->limit($limit)
            ->fetchArray();
    }

    #我的礼品列表
    public static function getMyCouponsList($hupuUid, $type = null, $status = 'now', $page = 1, $limit = 20)
    {
        $time  = time();
        $offset = ($page - 1) * $limit;

        $sql = 'SELECT a.*,b.img_path,b.title,b.mart,b.receive_url
            FROM kll_coupons_recevied as a LEFT JOIN kll_activity b ON a.activity_id=b.id
            WHERE a.hupu_uid=' . $hupuUid;
        if (null !== $type && ('' !== $type)) {
            $type = (int) $type;
            switch ($type) {
                case 0:
                    $sql .= ' AND a.root_type=0';
                    break;
                case 1:
                    $sql .= ' AND a.root_type=1';
                    break;
                case 2:
                    $sql .= ' AND a.root_type=2';
                    break;
                default:
                    $sql .= ' AND a.root_type IN (0,1)';
            }
        }
        if ('now' == $status) {
            $sql .= ' AND a.status=1 AND \'' . $time . '\'<= a.etime';
        } elseif ('over' == $status) {
            $sql .= ' AND a.status=1 AND \'' . $time . '\'> a.etime';
        } elseif ('use' == $status) {
            $sql .= ' AND a.status=2';
        }
        $sql .= ' ORDER BY a.recevied_date DESC,a.id DESC LIMIT ' . $offset . ',' . $limit;

        $connection = Doctrine_Manager::getInstance()->getConnection('kaluli');
        $searchDataList = $connection->execute($sql);
        $results = $searchDataList->fetchAll(PDO::FETCH_ASSOC);
        $connection->close();
        return $results;
    }

    # 获取用户领取状态
    public static function getCouponsStatusByUser($uid=0,$activityIds=array())
    {
        if(empty($uid) || empty($activityIds)) return false;
        $redis = sfContext::getInstance()->getDatabaseConnection('kaluliRedis');
        $redis->select(1);
        $key = 'kaluli_index_coupons_status_uid_'.$uid;
        $data = unserialize($redis->get($key));

        if(empty($data['status']))
        {
            $connection = Doctrine_Manager::getInstance()->getConnection('kaluli');
            $ids = '';
            foreach($activityIds as $v)
            {
                $ids .= "'{$v}',";
            }
            $ids = trim($ids,',');
            $sql = "select count(a.id) as count,a.activity_id,b.limits from kll_coupons_recevied  as a
                    join kll_activity as b
                    on a.activity_id = b.id
                    where a.root_type =1
                    and a.status=1
                    and a.hupu_uid='{$uid}'
                    and a.activity_id in ({$ids})
                    group by a.activity_id";
            $searchDataList = $connection->execute($sql);
            $tmp = $searchDataList->fetchAll(PDO::FETCH_ASSOC);

            $connection->close();

            $data['status'] = 1;
            $data['actitvity_ids'] = array();

            if(!empty($tmp))
            {
                foreach($tmp as $v)
                {
                    if($v['count']>=$v['limits'])
                    {
                        $data['actitvity_ids'][] = $v['activity_id'];
                    }
                }
            }
            $redis->set($key,serialize($data),600);
        }

        return $data;
    }
}