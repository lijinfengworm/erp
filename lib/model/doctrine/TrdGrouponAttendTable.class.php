<?php

/**
 * TrdGrouponAttendTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdGrouponAttendTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TrdGrouponAttendTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdGrouponAttend');
    }
    
    public function getCountByGid($gid)
    {
        $q = $this->createQuery()->select('count(*) as sum')->where('g_id = ?',$gid)->fetchOne();
        return $q->getSum(); 
    }
    public function getListByGid($gid,$limit)
    {
        return $this->createQuery()->where('g_id = ?',$gid)->orderBy('id desc')->limit($limit)->execute();
    }
    public function getHasAttend($gid,$uid)
    {
        $q = $this->createQuery()->where('g_id = ?',$gid)->addWhere('uid = ?',$uid)->fetchOne();
        if($q)
        {
            return true;
        }
        return false;
    }

    /*
    public function getYsetdayTopGids()
    {
        $stime  = date("Y-m-d")." 00:00:00";
        $tmp  =  strtotime($stime)-3600*24;
        $etime  =  date("Y-m-d H:i:s",$tmp);

        $info = $this->createQuery()
                ->select('count(*) AS total ,g_id ')
                ->where('created_at  > ?',$etime)
                ->andWhere("created_at  < ? ",$stime)
                ->groupBy("g_id")
                ->orderBy('total desc')
                ->limit("4")
                ->execute()
                ->toArray();

        $ids = array();
        foreach($info AS $key => $val)
        {
            $ids[] = $val['g_id'];
        }
        return $ids;
    }
    */

    public function getYsetdayTopGids()
    {
        $stime  = date("Y-m-d")." 00:00:00";
        $tmp  =  strtotime($stime)-3600*24;
        $etime  =  date("Y-m-d H:i:s",$tmp);
        $now   = date("Y-m-d H:i:s");

        $sql = 'SELECT COUNT( * ) AS total, groupon.id AS group_id
                FROM  `trd_groupon` AS groupon, trd_groupon_attend AS grouponatte
                WHERE grouponatte.g_id = groupon.id
                AND grouponatte.created_at >  "'.$etime.'"
                AND grouponatte.created_at <  "'.$stime.'"
                AND groupon.deleted_at is null
                AND groupon.status = 6
                AND groupon.start_time < "'.$now.'"
                AND groupon.end_time   > "'.$now.'"
                GROUP BY groupon.id
                ORDER BY total DESC
                LIMIT 0 , 4';

        $connection = Doctrine_Manager::getInstance()->getConnection('trade');
        $res  = $connection->execute($sql);
        $info =  $res->fetchAll(Doctrine_Core::FETCH_ASSOC);

        $ids = array();
        foreach($info AS $key => $val)
        {
            $ids[] = $val['group_id'];
        }
        return $ids;
    }
}