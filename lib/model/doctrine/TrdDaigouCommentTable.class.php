<?php

/**
 * TrdDaigouCommentTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdDaigouCommentTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TrdDaigouCommentTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdDaigouComment');
    }

    public function getComment($product_id,$is_img,$page,$page_num = 20){
         $query = $this->createQuery()
            ->select('id,user_id,user_name,content,imgs,tags_attr,attr,created_at')
            ->where('product_id = ?',$product_id)
            ->andWhere('status = ?',1);

         if($is_img)$query = $query->andWhere('imgs != ?','');

         return $query->offset(($page-1)*$page_num)
            ->limit($page_num)
            ->orderBy('created_at DESC')
            ->fetchArray();
    }

    public function getCommentCount($product_id,$is_img){
        $query = $this->createQuery()
            ->where('product_id = ?',$product_id)
            ->andWhere('status = ?',1);

        if($is_img)$query = $query->andWhere('imgs != ?','');

        return $query->count();
    }

    // 获取评价列表
    public function getCommentList($pid, $hasImg = 0, $tagId = 0, $page = 1, $pageSize = 20)
    {
        $offset = ($page - 1) * $pageSize;
        $params = array();
        $sql = 'SELECT tdc.id, tdc.user_id, tdc.user_name, tdc.content, tdc.imgs, tdc.tags_attr, tdc.attr, tdc.created_at FROM trd_daigou_comment tdc';
        if ($tagId) {
            $sql .= ' JOIN trd_daigou_comment_tags tdct ON tdc.id = tdct.daigou_comment_id';
        }
        $sql .= ' WHERE tdc.product_id = ? AND tdc.status = 1';
        $params[] = $pid;
        if ($hasImg) {
            $sql .= ' AND tdc.imgs != \'\'';
        }
        if ($tagId) {
            $sql .= ' AND tdct.tag_id = ?';
            $params[] = $tagId;
        }
        $sql .= ' ORDER BY tdc.created_at DESC LIMIT ' . $pageSize . ' OFFSET ' . $offset;
        $conn = Doctrine_Manager::getInstance()->getConnection('trade');
        $st = $conn->execute($sql, $params);
        return $st->fetchAll(Doctrine_Core::FETCH_ASSOC);
    }

    // 获取评价列表总条数
    public function getCommentListCount($pid, $hasImg = 0, $tagId = 0)
    {
        $params = array();
        $sql = 'SELECT COUNT(1) AS num FROM trd_daigou_comment tdc';
        if ($tagId) {
            $sql .= ' JOIN trd_daigou_comment_tags tdct ON tdc.id = tdct.daigou_comment_id';
        }
        $sql .= ' WHERE tdc.product_id = ? AND tdc.status = 1';
        $params[] = $pid;
        if ($hasImg) {
            $sql .= ' AND tdc.imgs != \'\'';
        }
        if ($tagId) {
            $sql .= ' AND tdct.tag_id = ?';
            $params[] = $tagId;
        }
        $conn = Doctrine_Manager::getInstance()->getConnection('trade');
        $st = $conn->execute($sql, $params);
        $res = $st->fetch(Doctrine_Core::FETCH_ASSOC);
        return $res['num'];
    }
}