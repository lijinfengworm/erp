<?php

/**
 * TrdAppActivityRemindTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdAppActivityRemindTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TrdAppActivityRemindTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdAppActivityRemind');
    }

    // 发送短信提醒
    public static function appNotify()
    {
        $datas = array();
        $time = time() + 30 * 60;
        $date = date('Y-m-d H:i:s', $time);
        $limit = 1000;
        $offset = 0;
        do {
            $data = self::getInstance()->createQuery('t')
                ->select('t.mobile, t.title')
                ->where('t.status = ?', 0)
                ->andWhere('t.start_time <= ?',$date)
                ->limit($limit)
                ->offset($offset)
                ->fetchArray();
            $datas = array_merge($datas, $data);
            $count = count($data);
            $offset += $count;
        } while ($count != 0);
        return $datas;
    }

    // 检查是否设置过提醒
    public function checkRemind($activityId, $mobile)
    {
        $query = self::getInstance()->createQuery()
            ->where('activity_id = ?', $activityId)
            ->andWhere('mobile = ?', $mobile)
            ->andWhere('status = ?', 0);
        return $query->count();
    }
}