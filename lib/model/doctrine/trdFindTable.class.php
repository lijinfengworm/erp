<?php

/**
 * trdFindTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class trdFindTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object trdFindTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('trdFind');
    }


    public static function myListQuery()
    {
        $query = self::getInstance()->createQuery('m')
            ->whereIn('m.status', array(0,1,2));

        $sort = sfContext::getInstance()->getUser()->getAttribute('trd_find.sort', null, 'admin_module');
        if(!$sort || !$sort[0]) $query = $query->orderBy('m.created_at DESC');

        return $query;
    }

    /*
   *deleteMessage
   **/
    public static function deleteMessage($id)
    {
        $return = array();
        try {
            $res = self::getInstance()->find($id);
            $res->setStatus(($res->getStatus() !=1) ? 1 : 2);
            $res->save();

            $return['status'] = true;
            $return['data']   = array('status'=>$res->getStatus());
        } catch (Exception $e) {
            $return['status'] = false;
        }

        return $return;
    }

    /*
   * 获取信息
   * 韩晓林
   */
    public  static  function getMessage($array = array()){
        if(!empty($array['limit']))
            $limit = $array['limit'];
        else
            $limit = 10;

        if(!empty($array['page']))
            $num = $array['page']*$limit;
        else
            $num = 0;

        if(isset($array['order']))
            $order = $array['order'];
        else
            $order = "publish_date DESC";

        $objs = self::getInstance()->createQuery('t')->limit($limit)->offset($num)->orderBy($order);

        if(!empty($array['select'])) $objs = $objs->select($array['select']);
        if(!empty($array['id'])) $objs = $objs->andwhere("t.id = ?",$array['id']);
        if(!empty($array['ids']))$objs = $objs->andwhere("t.id  in (" .  rtrim(join(",",$array['ids']),',') . ") ");
        if(!empty($array['day'])) $objs = $objs->andWhere('t.publish_date>= ?',date('Y-m-d H:i:s', strtotime("-{$array['day']} day")));
        if(!empty($array['root_id'])) $objs = $objs->andwhere('t.root_id = ?',$array['root_id']);
        if(!empty($array['children_id'])) $objs = $objs->andwhere('t.children_id = ?',$array['children_id']);
        if(!empty($array['store_id'])) $objs = $objs->andwhere('t.store_id = ?',$array['store_id']);
        if(!empty($array['not_id'])) $objs = $objs->andWhereIn('id', $array['not_id'], true);

        //条件后置
        $objs =  $objs->andWhere('t.status = 1');

        if(!empty($array['arr'])){
            return $objs = $objs->fetchArray();
        } elseif(!empty($array['count'])){
            return $objs = $objs->count();
        } else{
            return $objs = $objs->execute();
        }
    }

    public static function syncComment($id,$replyNum){
        $status = array('status'=>false);
        try{
            $obj = self::getInstance()->find($id);
            $obj->setReplyCount($obj->getReplyCount()-(1+$replyNum));
            $obj->save();
            $status['status'] = true;
        }catch (Exception $e){
            $status['msg'] = $e->getCode();
        }
        return $status;
    }

}