<?php

/**
 * KllMemberBenefitsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class KllMemberBenefitsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object KllMemberBenefitsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('KllMemberBenefits');
    }
    public static function getAll($bind = []){

        $data = self::getInstance()->createQuery();
        if (!empty($bind['select'])){
            $data->select($bind['select']);
        } else {
            $data->select("*");
        }
        //where 简单判断  如果复杂 建议新写函数
        if(!empty($bind['where']) && count($bind['where']) > 0) {
            foreach($bind['where'] as $k=>$v) {
                $data->addWhere($v);
            }
        }
        //limit
        if (!empty($bind['limit'])){
            $data->limit($bind['limit']);
        }

        if(!empty($bind['offset'])) {
            $data->offset($bind['offset']);
        }

        $data->orderBy('id desc');
        $data =  $data->fetchArray();

        if(!empty($bind['is_count'])) {
            $data = $data[0]['num'];
        }
        return $data;
    }
    /**
     * 检查是否可用
     */
    public static function useBenefist($account, $item_ids){
        $flag = 0;
        $nowtime = time();
        $check =  KllMemberBenefitsTable::getInstance()->createQuery()->where('code = ?',$account)->andWhere("status =?",1)->andWhere('start_time <= ?',$nowtime)->andWhere('end_time >= ?',$nowtime)->limit(1)->fetchOne();
        if($check){
            //检查是否可用
            $range = $check->getRange();
            $times = $check->getTimes();
            if($times > 0){
                if($range == 1){
                    $flag = 1;
                }else{
                    $id = $check->getId();
                    $item = KllMemberBenefitsSkuTable::getInstance()->findByMbId($id);
                    $items = [];
                    if(!empty($item)){
                        foreach ($item as $key => $val) {
                            $items[] = $val->getSkuId();
                        }
                        $join = array_intersect($items, $item_ids);
                        !empty($join) && $flag = 1;
                    }
                }
            }else{
                $flag = 0;
            }
            
        }
        return $flag;
    }
    /**
     * 根据ID检查是否可用
     */
    public static function useFlagBenefist($id, $item_ids){
        $flag = 0;
        $nowtime = time();
        $check =  KllMemberBenefitsTable::getInstance()->createQuery()->where('id = ?',$id)->andWhere("status =?",1)->andWhere('start_time <= ?',$nowtime)->andWhere('end_time >= ?',$nowtime)->limit(1)->fetchOne();
        if($check){
            //检查是否可用
            $range = $check->getRange();
            $times = $check->getTimes();
            if($times > 0){
                if($range == 1){
                    $flag = 1;
                }else{
                    $id = $check->getId();
                    $item = KllMemberBenefitsSkuTable::getInstance()->findByMbId($id);
                    $items = [];
                    if(!empty($item)){
                        foreach ($item as $key => $val) {
                            $items[] = $val->getSkuId();
                        }
                        $join = array_intersect($items, $item_ids);
                        !empty($join) && $flag = 1;
                    }
                }
            }else{
                $flag = 0;
            }
            
        }
        return $flag;
    }
    
}