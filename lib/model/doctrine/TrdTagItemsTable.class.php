<?php

/**
 * TrdTagItemsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdTagItemsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TrdTagItemsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdTagItems');
    }

    public function autoSave($name, $item_all_id) {
        $tagTable = TrdTagsTable::getInstance();

        $tag = $tagTable->getTag($name);

        $TrdTagItem = new TrdTagItems();
        $TrdTagItem->setItemAllId($item_all_id);
        $TrdTagItem->setTagId($tag->getId());
        $TrdTagItem->save();
    }

    public function byItemAllId($item_all_id) {
        return self::getInstance()->createQuery()
            ->Where('item_all_id = ?', $item_all_id)
            ->execute();
    }

    public function del($id) {
        return self::getInstance()->createQuery('a')
            ->delete()
            ->where("id = ? ", $id)
            ->execute();
    }

    public function  getByTagId($id) {
        $rs = self::getInstance()->createQuery('a')
            ->select('*')
            ->where("tag_id = ?", $id)
            ->orderby("created_at desc")
            ->execute();

        return $rs;
    }

    public function getItemByTagForVoice($tagname, $offset = 0, $ids = "") {
        $sql = self::getInstance()->createQuery('a')
            ->select('*')
            ->leftJoin("a.TrdTags t")
            ->leftJoin("a.TrdItemAll i")
            ->where("t.name = ? ", $tagname)
            ->andWhere('i.is_soldout = 0')
            ->andWhere('i.is_hide = ?', TrdItemTable::SHOW)
            ->andWhere('i.status = ?', TrdItemTable::STATUS_NORMAL)
            ->offset($offset)
            ->limit(1);

        if($ids) {
            $sql->addWhere("item_all_id not in  ({$ids})");
        }

        return $sql->fetchOne();
    }

    public function getItemByTagForVoiceDefault($limit, $ids = "") {
        $sql = self::getInstance()->createQuery('a')
            ->select('*')
            ->leftJoin("a.TrdTags t")
            ->leftJoin("a.TrdItemAll i")
            ->where('i.is_soldout = 0')
            ->andWhere('i.is_hide = ?', TrdItemTable::SHOW)
            ->andWhere('i.status = ?', TrdItemTable::STATUS_NORMAL)
            ->groupby('a.item_all_id')
            ->limit($limit);

        if($ids) {
            $sql->addWhere("item_all_id not in  ({$ids})");
        }

        return $sql->execute();
    }
}
