<?php

/**
 * TrdGoodsNotice
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    HC
 * @subpackage model
 * @author     HoopChina.com Dev Team
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class TrdGoodsNotice extends BaseTrdGoodsNotice
{
    public function postInsert($event)
    {
        $message = array(
            'id' => $this->getId(),
            'type' => 'create',
            'channelType' => 'goods_notice'
        );
        $this->sendMqMessage($message);

        parent::postInsert($event);

    }

    public function preUpdate($event)
    {
        $oldvalue = $this->getModified(true);
        if($oldvalue['status'] == 0 || $oldvalue['status'] == 1){
            $new = $this->getModified();
            # 审核未通过
            if($new['status'] == 2)
            {
                $message = array(
                    'id' => $this->getId(),
                    'type' => 'delete',
                    'channelType' => 'goods_notice',
                );
                $this->sendMqMessage($message);
            }
            else
            {
                $modified = array_keys($new);
                $updateFields = array(
                    'goods_id',
                    'supplier_id',
                    'pic',
                    'tag_type',
                    'type',
                    'status',
                );
                if (array_intersect($updateFields, $modified)) {#消息队列
                    $message = array(
                        'id' => $this->getId(),
                        'type' => 'update',
                        'channelType' => 'goods_notice',
                    );
                    $this->sendMqMessage($message);
                }
            }

        }

        parent::preUpdate($event);
    }

    public function postDelete($event)
    {
        $message = array(
            'id' => $this->getId(),
            'type' => 'delete',
            'channelType' => 'goods_notice'
        );
        $this->sendMqMessage($message);
        parent::postDelete($event);
    }

    public function preSave($event) {
//        $new = $this->getModified();
//
//        if ($this->isNew() || isset($new['hits'])){
//            //获取rank的公式
//            $this->setRank($this->getTrueRank());
//        }
        parent::preSave($event);
    }

    public function sendMqMessage($message)
    {
        $amqpParams = sfConfig::get("app_mabbitmq_options_shihuo");
        $connection = new AMQPConnection($amqpParams['params']['host'], $amqpParams['params']['port'], $amqpParams['params']['user'], $amqpParams['params']['pass'], $amqpParams['params']['vhost']);
        $channel = $connection->channel();
        $arguments = array(
            "x-dead-letter-exchange" => array("S", "amq.topic"),
            "x-message-ttl" => array("I", 1500),
            "x-dead-letter-routing-key" => array("S", "shihuo.goods.notice.detail")
        );
        $channel->queue_declare('trd_goods_notice_deferred', false, true, false, false, false, $arguments);

        $msg = new AMQPMessage(json_encode($message));
        $channel->basic_publish($msg, '', 'trd_goods_notice_deferred');

    }
}
