<?php

/**
 * KaluliOrderAttrTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class KaluliOrderAttrTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object KaluliOrderAttrTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('KaluliOrderAttr');
    }


    //显示attr
    public static function  getFormatAttr($attr,$format = 'txt') {
        if($format == 'txt') {
            $attr = json_decode(html_entity_decode($attr,ENT_QUOTES),true);
            $content = array();
            unset($attr['name']);
            unset($attr['price']);
            foreach ($attr as $kk=>$vv){
                if ($kk != 'img'){
                    $content[$kk] = $vv;
                }
            }
            return join(',',$content);
        }

    }


    public static function  importFormatAttr($attr,$format = 'txt') {
        if($format == 'txt') {
            $attr = json_decode(html_entity_decode($attr,ENT_QUOTES),true);
            $content = array();
            unset($attr['name']);
            unset($attr['price']);
            unset($attr['img']);
            $_str = '';
            $i = 0;
            foreach ($attr as $kk=>$vv){
                if($i == 0) {
                    $_str = $vv;
                }
                $i++;
            }
            return $_str;
            /*
            $_returnArr = explode('@@@@@@@@@@@@@@@',$_str);
            return implode(" ",$_returnArr);
            return $_str;
            */
        }
    }




    //通过orderid查询
    public static function  getOneByOrderId($order_id,$is_toarray = false) {
        $info = self::getInstance()
            ->createQuery()
            ->select('*')
            ->andWhere('order_id = ?',$order_id)
            ->fetchOne();
        if(empty($info)) return false;
        if($is_toarray) return $info;
        $info = $info->toArray();
        if(empty($field)) return $info;
        return $info[$field];
    }


    /**
     * 通过自定义条件获取全部的数据
     * Abuout 梁天
     * ->from('TrdSpecial t')
     *   ->select('name,c.name ffff')->leftJoin('t.TrdSpecialCate c on t.cateid = c.id')
     */
    public static function  getAll($bind = array()) {
        $data = self::getInstance()->createQuery();
        //select
        if (!empty($bind['select'])){
            $data->select($bind['select']);
        } else {
            $data->select("*");
        }
        //leftJoin
        if (!empty($bind['leftJoin'])){
            $data->leftJoin($bind['leftJoin']);
        }
        //where 简单判断  如果复杂 建议新写函数
        if(!empty($bind['where']) && count($bind['where']) > 0) {
            foreach($bind['where'] as $k=>$v) {
                $data->addWhere($v);
            }
        }

        //whereIn 简单判断  如果复杂 建议新写函数
        if(!empty($bind['whereIn']) && count($bind['whereIn']) > 0) {
            foreach($bind['whereIn'] as $k=>$v) {
                $data->WhereIn($k,$v);
            }
        }

        //order
        if (!empty($bind['order'])){
            $data->orderBy($bind['order']);
        } else {
            $data->orderBy('id desc');
        }
        //limit
        if (!empty($bind['limit'])){
            $data->limit($bind['limit']);
        }

        if(!empty($bind['offset'])) {
            $data->offset($bind['offset']);
        }

        $data =  $data->fetchArray();
        if(!empty($bind['is_count'])) {
            $data = $data[0]['num'];
        }
        return $data;
    }


    /**
     * 获取一条会员信息
     */
    public static function getByOrderIdOne($order_id,$is_array = true,$field = '') {
        $info = self::getInstance()
            ->createQuery()
            ->select('*')
            ->andWhere('order_id = ?',$order_id)
            ->fetchOne();
        if(empty($info)) return false;
        if(empty($is_array)) return $info;
        $info = $info->toArray();
        if(empty($field)) return $info;
        return $info[$field];
    }



}