<?php

/**
 * TrdGoodsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdGoodsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object TrdGoodsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdGoods');
    }

    public static function getHoutaiList($ids)
    {
        if(empty($ids)) return false;
        $return = $brand = $category = array();
        $data = self::getInstance()->createQuery()->whereIn('id',$ids)->fetchArray();

        foreach($data as $k=>$v)
        {
            if(empty($brand[$v['root_brand_id']]))
            {
                $tmp = TrdGoodsBrandTable::getInstance()->find($v['root_brand_id']);
                $brand[$v['root_brand_id']] = $b = !empty($tmp->name)?$tmp->name:'无';
            }
            if(empty($category[$v['root_category_id']]))
            {
                $tmp = TrdGoodsCategoryTable::getInstance()->find($v['root_category_id']);
                $category[$v['root_category_id']] = $c =  !empty($tmp->name)?$tmp->name:'无';
//var_dump($category[$v['root_category_id']]);exit;
            }
            $s = '';
            if(!empty($v['type']))
            {
                $types = explode(',',$v['type']);
                foreach($types as $v2)
                {
                    if(!empty(TrdGoodsForm::$type[$v2]))
                    {
                        $s .= TrdGoodsForm::$type[$v2].',';
                    }
                }
            }
            $s = trim($s,',');
            if(empty($s)) $s = '无';
            $return[] = array(
                'id'=>$v['id'],
                'name'=>$v['name'],
                'brand'=>$b,
                'category'=>$c,
                'type'=>$s,
            );

        }

        return $return;
    }

    public static function getGoodsObj($id){
        if(!$id) return false;

        if($t = self::getInstance()->find($id)){
            return $t;
        }else{
            return false;
        }
    }

    public static function getGoodsDetail($id,$styleId=null)
    {
        $data = CacheModel::getCache();
        if(empty($data))
        {
            $tmp = self::getInstance()->createQuery()->andWhere('id=?',$id)->andWhere('status=1')->fetchArray();
            if(empty($tmp[0])) return ;
            $data  = $tmp[0];
            $tmp = TrdGoodsAttrTable::getInstance()->createQuery()->where('goods_id =?',$id)->fetchArray();
            if(!empty($tmp[0])) {
                $data['content'] = $tmp[0]['content'];
                $data['pic_count'] = $tmp[0]['pic_count'];
            }
            if(!empty($styleId))
            {
                $tmp = TrdGoodsStyleTable::getInstance()->createQuery()->andWhere('id=?',$styleId)->andWhere('status=1')->fetchArray();
                if(!empty($tmp[0]['pic'])) $data['pic'] = $tmp[0]['pic'];
            }

            CacheModel::setCache($data,60);
        }
        return $data;
    }

    public static function getDetail($id)
    {
       // self::getInstance()->createQuery()->
    }

    public static function getGoodsByIds($ids)
    {
        $data = CacheModel::getCache();
        if(empty($data))
        {
            $data = self::getInstance()->createQuery()->select('id,name,type')->andWhereIn('id',$ids)->andWhere('status = 1')->fetchArray();
            if(!empty($data)){
                foreach($data as $k=>$v)
                {
                    $data[$v['id']] = $v;
                }
            }
            CacheModel::setCache($data,60);
        }
        return $data;
    }
}