<?php

/**
 * trdGrouponTreasureTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class trdGrouponTreasureTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object trdGrouponTreasureTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('trdGrouponTreasure');
    }

    public static function getInfo($id, $uid){
        return self::getInstance()
            ->createQuery()
            ->where('id = ?', $id)
            ->andWhere('hupu_uid = ?', $uid)
            ->fetchOne();
    }

    //正在展示的的震团
    public static function getTreasure(){
        $treasure = self::getInstance()
            ->createQuery()
            ->where('status = 2')
            ->andWhere('end_time > ?', time())
            ->orderBy('start_time asc')
            ->fetchOne();

        $res = array();
        if($treasure){
            $res['status']      =  $treasure->getStartTime() < date('Y-m-d H:i:s')  ? ($treasure->getIsSold()  == 0 ? "start" : "sold") : "not_start";
            $res['start_time']  =  $treasure->getStartTime();
            $res['end_time']    =  $treasure->getEndTime();
            $res['id']          =  $treasure->getId();
            $res['title']       =  $treasure->getTitle();
            $res['price']       =  $treasure->getPrice();
            $res['img_path']    =  $treasure->getImagePath();
        }

        return $res;
    }

    //按ID查询
    public static function getById($id){
        $treasure = self::getInstance()->find($id);
        if(!$treasure || $treasure->getStatus() != 2){
            return false;
        }else{
            $res = array();
            $res['status']          =   $treasure->getStartTime() < date('Y-m-d H:i:s')  ? "start" : "not_start";
            $res['id']              =   $treasure->getId();
            $res['url']             =   $treasure->getUrl();
            $res['title']           =   $treasure->getTitle();
            $res['start_time']      =   $treasure->getStartTime();
            $res['end_time']        =   $treasure->getEndTime();
            $res['intro']           =   $treasure->getIntro();
            $res['memo']            =   json_decode(gzuncompress(base64_decode($treasure->getMemo())), true);
            $res['img_path']        =   $treasure->getImagePath();
            $res['price']           =   $treasure->getPrice();
            $res['original_price']  =   $treasure->getOriginalPrice();
            $res['discount']        =   $treasure->getDiscount();
            $res['is_sold']         =   $treasure->getIsSold();
            $banme = trdBrandTable::getInstance()->getAllName();
            $res['brand']       =  array(
                'id'   => $treasure->getBrandId(),
                'name' => $banme[$treasure->getBrandId()]
            );
            $canme = trdGrouponCategoryTable::getAllCategoryName();
            $res['category']    =  array(
                'id'   => $treasure->getCategoryId(),
                'name' => $canme[$treasure->getCategoryId()]
            );

            $shopInfo =TrdBusinessmanTable::getShopInfo($treasure->getHupuUid());
            $res['shop']        =  array(
                'url'   => $shopInfo['shop_url'],
                'name'  => $shopInfo['shop_name']
            );
        }

        return $res;
    }
}