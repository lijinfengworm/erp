<?php

/**
 * TrdActivity
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    HC
 * @subpackage model
 * @author     HoopChina.com Dev Team
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class TrdActivity extends BaseTrdActivity
{
    public function getExchangeStyle(){
        if ($this->type == 0) return "优惠券";
        if ($this->type == 1) return "礼品卡";
        if ($this->type == 2) return "实物礼品";
    }
    
    public function save(Doctrine_Connection $conn = null) 
    {
        $modifiedFields = $this->getModified(true);     
        parent::save($conn);

        //同步积分日志到个人中心
//        $syncAskKeyArray =array('title','list_id','exchange_type','type','total','recevied','integral','gold','start_date','expiry_date','img_path','is_delete');
//        if($this->isNew() || array_intersect($syncAskKeyArray,array_keys($modifiedFields)))
//        {        
//            $this->syncAskToSphinx();
//        }
        return $this->getId();
        
    }

    //发送消息到个人中心
    public function syncAskToSphinx()
    {
        hcRabbitMQPublisher::getInstance('shihuo_user')->publish(new hcAMQPMessage(array('type'=>'update','activity_id'=>$this->getId())),'shihuo_user_account_activitylist');
        return true;
    }

    public function simpleFormatApp($href="")
    {
        $data['id'] = $this->getId();
        $data['title'] = $this->getTitle();
        $data['img_path'] = $this->getImgPath();
        $data['start_date'] = substr($this->getStartDate(),0,10);
        $data['expiry_date'] = substr($this->getExpiryDate(),0,10);
        $data['limit'] = $this->getLimits();
        if($href)
        {
            $data['href'] = $href;
        }else{
            $data['href'] = "shihuo://youhuiquan/id/".$this->getId();
        }

        return $data;
    }

    public function  completeFormatApp()
    {
        $exchange_type = "";
        if ($this->getExchangeType() == 0){
            $exchange_type =  $this->getIntegral().'积分 + '.$this->getGold().'金币';
        } else if ($this->getExchangeType() == 2){
            $exchange_type = $this->getIntegral().'积分';
        } else if ($this->getExchangeType() == 3){
            $exchange_type = $this->getGold().'金币';
        } else if ($this->getExchangeType() == 4){
            $exchange_type = '免费兑换';
        }

        $content = $this->getContent();
        $content = trim(strip_tags($content,'<br />'));
        $content = preg_replace('/\s/', ' ', $content);
        $content = str_replace('&nbsp;','',$content);

        $data = array();
        $data['id'] = $this->getId();
        $data['title'] = $this->getTitle();
        $data['total'] = $this->getTotal();
        $data['received'] = $this->getRecevied()?$this->getRecevied():0;
        $data['integral'] = $this->getIntegral();
        $data['gold']     = $this->getGold();
        $data['img_path'] = $this->getImgPath();
        $data['start_date'] = substr($this->getStartDate(),0,10);
        $data['expiry_date'] = substr($this->getExpiryDate(),0,10);
        $data['limit']     = $this->getLimits();
        $data['exchange_type'] = $exchange_type;
        $data['remain'] = (string)($data['total']-$data['received']);
        $data['content'] = $content;

        return $data;
    }

}
