<?php

/**
 * TrdNewsTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class TrdNewsTable extends Doctrine_Table
{

    /*  新闻状态 */
    public static  $NOT_AUDIT = '2';
    /*  被拒绝 */
    public static  $REFUSE_AUDIT = '3';
    /*  被退回 */
    public static  $RETURN_AUDIT = '5';
    /*  通过 */
    public static  $SUCC_AUDIT = '1';
    /*  修改后通过  */
    public static  $EDIT_SUCC_AUDIT = '4';
    /* 全部通过  */
    public static  $ALL_SUCC_AUDIT = '1,4';

    /* 定时状态 */
    public static $TIMING_TYPE = 2;


    /**
     * Returns an instance of this class.
     *
     * @return object TrdNewsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('TrdNews');
    }

    public static function myListQuery() {
        $query = self::getInstance()->createQuery('m')
            ->where('m.is_delete = 0')
            ->orderBy('m.created_at desc');
        return $query;
    }

    /*
     * 获取定时新闻
     */
    public static function getTimingIntervalData($field = 'timing_interval') {
        $data = self::getInstance()->createQuery('m')
            ->select($field)
            ->where('m.is_delete = ?',self::$TIMING_TYPE)
            ->fetchArray();
        return $data;
    }



    public static function getAuditDateString($date = '') {
        if(empty($date) || $date == '0000-00-00 00:00:00') return ' - ';
        return $date;
    }

    public static function getAuditMessageString($message = '') {
        if(empty($message)) return ' - ';
        return $message;
    }

    public static function getAuditUsereString($user = '') {
        if(empty($user)) return ' - ';
        return $user;
    }

    /**
     * 展示审核状态
     */
    public static function getAuditStatusString($auditStatus = ''){
        $auditArr = array(1=>'<span class="c-green">审核通过</span>',2=>'待审核',3=>'被拒绝',4=>'<span class="c-blue">修改后通过</span>',5=>'被退回');
        if(!empty($auditArr[$auditStatus])) return $auditArr[$auditStatus];
        return ' - ';
    }

    /**
     * 通过自定义条件获取全部的数据
     * Abuout 梁天
     */
    public static function  getAllNews($bind = array()) {
        $data = self::getInstance()->createQuery();
        //select
        if (!empty($bind['select'])){
            $data->select($bind['select']);
        } else {
            $data->select("*");
        }
        //where 简单判断  如果复杂 建议新写函数
        if(!empty($bind['where']) && count($bind['where']) > 0) {
            foreach($bind['where'] as $k=>$v) {
                $data->addWhere($v);
            }
        }
        //whereIn 简单判断  如果复杂 建议新写函数
        if(!empty($bind['whereIn']) && count($bind['whereIn']) > 0) {
            foreach($bind['whereIn'] as $k=>$v) {
                $data->WhereIn($k,$v);
            }
        }
        //order
        if (!empty($bind['order'])){
            $data->orderBy($bind['order']);
        } else {
            $data->orderBy('id desc');
        }
        //limit
        if (!empty($bind['limit'])){
            $data->limit($bind['limit']);
        }

        if(!empty($bind['offset'])) {
            $data->offset($bind['offset']);
        }


        $data =  $data->fetchArray();
        if(!empty($bind['is_count'])) {
            $data = $data[0]['num'];
        }
        return $data;
    }


    /*
     *
     *删除回复同步数量
     **/
    public static function syncComment($id,$replyNum){
        $status = array('status'=>false);
        try{
            $news = trdNewsTable::getInstance()->find($id);
            $news->setReplyCount($news->getReplyCount()-(1+$replyNum));
            $news->save();

            $status['status'] = true;
        }catch (Exception $e){
            $status['msg'] = $e->getCode();
        }

        return $status;
    }


    /*
    * 删除单条内容
    */
    public static function deleteMessage($id=0,$msg_source='',$list_page=0) {
        $res = self::getInstance()->find($id);
        $res->setIsDelete(1);
        $res->save();

        return true;
    }

    /*
     * 删除多条内容
     */

    public static function deleteMessages($ids) {
        if (empty($ids))
            return false;

        foreach($ids as $k=>$v){
            $res = self::getInstance()->find($v);
            $res->setIsDelete(1);
            $res->save();
        }

        return true;
    }


    /**
     * 识货资讯平台新闻总数获取
     * @param $root_id   一级分类ID
     * @param $children_id  二级分类ID
     * @param $type     商品类型
     * @param int $fifter_id  过滤一条置顶信息
     * @param array $root_type  文章类型
     * @param int $store_id  商品标签ID
     * @param bololean $is_audit  是否查询审核过的文章  默认 true
     * @return mixed
     */
    public static function getShiHuoInfoCount($root_id, $children_id, $type, $fifter_id = 0,$root_type = array(),$store_id = 0,$is_audit = true){
        $query = self::getInstance()->createQuery('t')
            ->select('count(t.id) as num');
        //->andWhere('t.publish_date <= ?',date('Y-m-d H:i:s',time()));
        if (empty($root_id) && empty($children_id)) $query = $query->andWhere('t.id != ?',$fifter_id);
        if ($root_id)     $query = $query->andWhere('t.root_id = ?',$root_id);
        if ($children_id) $query = $query->andWhere('t.children_id = ?',$children_id);
        if ($root_type)   $query = $query->andWhere("t.root_type in (" . join(",", $root_type) . ") ");
        if ($store_id)    $query = $query->andWhere('t.store_id = ?',$store_id);
        if ($type){
            $query = $query->andWhere('t.type = ?',$type);
        } else {
            $query = $query->andWhere('t.is_display_index = ?',1);
        }
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        $query = $query->andWhere('t.is_delete = 0')->fetchArray();

        return $query[0]['num'];
    }


    /**
     * 识货资讯平台新闻分页获取
     * @param int $page  当前页码
     * @param int $fifter_id  过滤ID
     * @param $root_id   一级分类
     * @param $children_id  二级分类
     * @param $type   商品类型
     * @param array $root_type  文章类型
     * @param int $page_size   每页展示多少个
     * @param int $store_id   商城标签ID
     * @param null $last_time   最后更新时间
     * @param bololean $is_audit 是否查询审核过的文章  默认 true
     * @return mixed
     */
    public static function getShiHuoInfoByPage($page = 1,$fifter_id = 0,$root_id, $children_id, $type, $root_type = array(), $page_size = 30, $store_id = 0, $last_time = null,$is_audit = true){
        $query =  self::getInstance()->createQuery('t')
            //->andWhere('t.publish_date <= ?',date('Y-m-d H:i:s',time()))
            ->limit($page_size)
            ->orderBy('t.publish_date desc, t.id desc, t.hits desc');
        if (empty($root_id) && empty($children_id)) $query = $query->andWhere('t.id != ?',$fifter_id);
        if ($root_id)     $query = $query->andWhere('t.root_id = ?',$root_id);
        if ($children_id) $query = $query->andWhere('t.children_id = ?',$children_id);
        if ($root_type)   $query = $query->andWhere("t.root_type in (" . join(",", $root_type) . ") ");
        if ($store_id)    $query = $query->andWhere('t.store_id = ?',$store_id);
        if ($type){
            $query = $query->andWhere('t.type = ?',$type);
        } else {
            $query = $query->andWhere('t.is_display_index = ?',1);
        }
        if($last_time) {
            $query = $query->andWhere('t.publish_date< ?', $last_time);
        } else {
            $query = $query->offset(($page - 1) * $page_size);
        }
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return  $query->andWhere('t.is_delete = 0')->execute();
    }

    /*
     * 识货资讯平台24,48,72h排行榜
     */
    public static function getShiHuoInfoRankingList($days =1,$limit =10,$is_audit = true){
        $data =  self::getInstance()->createQuery('t')
            ->select('t.title,t.subtitle')
            ->where('t.is_delete = 0')
            ->andWhere('t.goods_state = 0')
            ->andWhere('t.publish_date>= ?',date('Y-m-d H:i:s', strtotime("-$days day")))
            ->orderBy('t.hits desc, t.id desc')
            ->limit($limit);
        if($is_audit) {
            $data->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return   $data->execute();
    }

    /*
     * 为了不影响其他在用的方法，单独写
     * 识货海淘资讯平台24,48,72h排行榜
     */
    public static function getShiHuoHaitaoInfoRankingList($days =1,$limit =10,$type,$is_audit = true){
        $query =  self::getInstance()->createQuery('t')
            ->select('t.title,t.subtitle')
            ->where('t.is_delete = 0')
            ->andWhere('t.goods_state = 0')
            ->andWhere('t.publish_date>= ?',date('Y-m-d H:i:s', strtotime("-$days day")))
            ->orderBy('t.hits desc, t.id desc')
            ->limit($limit);
        if ($type) $query = $query->andWhere('t.type = ?',$type);
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return  $query->execute();
    }

    /*
     * 识货资讯平台新闻获取
     */
    public static function getNewShiHuoInfo($limit = 10, $root_id, $children_id,$is_audit = true){
        $query =  self::getInstance()->createQuery('t')
            //->andWhere('t.publish_date <= ?',date('Y-m-d H:i:s',time()))
            ->limit($limit)
            ->orderBy('t.publish_date desc, t.id desc, t.hits desc');
        if ($root_id)     $query = $query->andWhere('t.root_id = ?',$root_id);
        if ($children_id) $query = $query->andWhere('t.children_id = ?',$children_id);
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return  $query->andWhere('t.is_delete = 0')
                      ->andWhere('t.goods_state = 0')
                      ->execute();
    }

    /*
     * 获取message的通用条件
     */
    private static function messagesCondition(Doctrine_Query $query) {
        return $query->andWhere($query->getRootAlias() . '.is_delete = 0');
    }

    public static function getMessageById($id) {
        $query = self::getInstance()->createQuery('m')
            ->andWhere('m.id= ?', $id);
        return self::messagesCondition($query)
            ->fetchOne();
    }

    public static function getMessageByIds($ids) {
        if (empty($ids))
            return array();
        $query = self::getInstance()->createQuery('m');
        return self::voiceCommonQuery($query)
            ->andWhereIn('m.id', $ids)
            ->execute();
    }

    /*
    * 返回新鲜事的消息
    */

    public static function getNewEventMessage($id,$is_audit = true) {
        $query = self::getInstance()->createQuery('m')
            ->where('m.id= ?', $id)
            ->andWhere('m.is_delete = 0');
        if($is_audit) {
            $query->andWhere('m.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return self::messagesCondition($query)->fetchOne();
    }

    public static function youhuiSyncToSphinx($status,$newsId)
    {
        if (is_array($newsId)){
            if ($status){
                foreach ($newsId as $v){
                    hcRabbitMQPublisher::getInstance('shihuo_news')->publish(new hcAMQPMessage(array('id'=>$v,'type'=>1)));
                }
            } else {
                foreach ($newsId as $v){
                    hcRabbitMQPublisher::getInstance('shihuo_news')->publish(new hcAMQPMessage(array('id'=>$v,'type'=>0)));
                }
            }

        } else {
            if ($status){
                hcRabbitMQPublisher::getInstance('shihuo_news')->publish(new hcAMQPMessage(array('id'=>$newsId,'type'=>1)));
            } else {
                hcRabbitMQPublisher::getInstance('shihuo_news')->publish(new hcAMQPMessage(array('id'=>$newsId,'type'=>0)));
            }
        }
        return true;
    }

    public function getByIds($ids,$sort = 'publish_date desc',$is_audit = true) {
        if (empty($ids)) return false;
        $query =  self::getInstance()
            ->createQuery('t')
            ->Where("id in (" . join(",", $ids) . ") ")
            ->andwhere('t.is_delete = ?', 0)
            ->orderBy($sort);
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return $query->execute();
    }

    //首页代购
    public function getIndexHaitaoInfoByIds($ids,$is_audit = true) {
        if (empty($ids)) return false;
        $objs = self::getInstance()
            ->createQuery('t')
            ->andWhere('t.is_shopping = 1')
            ->andWhere('t.is_delete = ?', 0)
            ->andWhere("t.id in (" . join(",", $ids) . ") ")
            ->limit(4);
        if($is_audit) {
            $objs->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }

        $objs = $objs->execute();



        if(count($objs) == 0)
        {
            return array();
        }

        $ids4 = array();
        $idtags = array();
        foreach($objs AS $key => $val)
        {
            $idtags[] =  $val->getId();
        }

        $count = 0;
        foreach($ids AS $key => $val)
        {
            if($count <4 && in_array($val,$idtags))
            {
                $ids4[] = $val;
                $count++;

                if($count == 4)
                {
                    break;
                }
            }
        }

        if (count($objs) > 0) {
            foreach ($objs as $r) {
                $result[$r->getId()] = $r;
            }
        } else {
            return array();
        }

        $result2 = array();
        foreach ($ids4 AS $key => $id) {
            $result2[$id] = $result[$id];
        }

        $items = array();
        foreach ($result2 as $re) {
            $items[$re->getId()] = array(
                'id' => $re->getId(),
                'title' => $re->getTitle(),
                'price' => $re->getPrice(),
                'img_url' => str_replace("thumbnail-","",$re->getImgPath())
            );
        }
        return $items;
    }

    /*
    * 获取信息
    * 韩晓林
    */
    public  static  function getMessage($array = array()){
        if(!empty($array['limit']))
            $limit = $array['limit'];
        else
            $limit = 10;

        if(!empty($array['page']))
            $num = $array['page']*$limit;
        else
            $num = 0;

        if(!empty($array['order']))
            $order = $array['order'];
        else
            $order = "publish_date DESC";

        $objs = self::getInstance()->createQuery('t')->limit($limit)->offset($num)->orderBy($order);

        if(!empty($array['select'])) $objs = $objs->select($array['select']);
        if(!empty($array['id']))     $objs = $objs->andwhere("t.id = ?",$array['id']);
        if(!empty($array['ids']) && is_numeric($array['ids'][0]))    $objs = $objs->andwhere("t.id  in (" .  rtrim(join(",",$array['ids']),',') . ") ");
        if(!empty($array['root_id']))     $objs = $objs->andwhere('t.root_id = ?',$array['root_id']);
        if(!empty($array['children_id'])) $objs = $objs->andwhere('t.children_id = ?',$array['children_id']);
        if(!empty($array['store_id']))    $objs = $objs->andwhere('t.store_id = ?',$array['store_id']);
        if(!empty($array['type']))   $objs = $objs->andwhere('t.type = ?',$array['type']);
        if(!empty($array['day']))    $objs = $objs->andWhere('t.publish_date>= ?',date('Y-m-d H:i:s', strtotime("-{$array['day']} day")));
        if(!empty($array['root_type']))   $objs = $objs->andWhereIn('root_type', $array['root_type']);
        if(!empty($array['not_id']))      $objs = $objs->andWhereIn('id', $array['not_id'], true);

        //条件后置
        $objs =  $objs->andWhere('t.is_delete = 0')->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');

        if(!empty($array['arr']))
            return $objs = $objs->fetchArray();
        elseif(!empty($array['count']))
            return $objs = $objs->count();
        else
            return $objs = $objs->execute();
    }

    /*最近几天内的最多点击数排名*/
    public function getHotNews($limit = 4 ,$day = 7,$type = null ,$root_type = null,$store_id= null,$root_id= null,$children_id= null,$is_audit = true){
        $objs = self::getInstance()->createQuery('t')
            ->andWhere('t.publish_date>= ?',date('Y-m-d H:i:s', strtotime("-$day day")));

        if($type)        $objs = $objs->addwhere('t.type = ?',$type);
        if($root_id)     $objs = $objs->andwhere('t.root_id = ?',$root_id);
        if($children_id) $objs = $objs->andwhere('t.children_id = ?',$children_id);
        if($store_id)    $objs = $objs->andwhere('t.store_id = ?',$store_id);
        if($root_type)   $objs = $objs->andWhere('root_type = ?',$root_type);
        if($is_audit)    $objs->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        $objs = $objs->andWhere('t.is_delete = 0')
                     ->orderBy('t.hits desc, t.id desc')
                     ->limit($limit)
                      ->execute();

        $items = array();
        foreach ($objs as $re) {
            $items[$re->getId()] = array(
                'id' => $re->getId(),
                'type' => $re->getType(),
                'title' => $re->getTitle(),
                'subtitle' => $re->getSubtitle(),
                'price' => $re->getPrice(),
                'img_url' => $re->getImgPath(),
                'root_type'=>(int)$re->getRootType(),
            );
        }

        return $items;
    }

    public static function getNewsByRand($type=0,$limit = 4,$is_audit = true)
    {
        $query = self::getInstance()
            ->createQuery('t')
            ->where('is_shopping = 1')
            ->addwhere('is_delete = 0')
            ->orderBy('rand()')
            ->limit($limit);

        if($is_audit) {
            $query->andWhere('audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }

        if($type)
        {
            $query->addwhere('type = ?',$type);
        }

        return $query->execute();
    }

    /*某个分类下最热新闻*/
    public function getHotByType($id,$type = 'root_id' ,$day = null,$limit = 5,$is_audit = true){
        $objs = self::getInstance()->createQuery('t')
            ->where('t.is_delete = 0')
            ->andwhere('t.goods_state = ?',0)
            ->andwhere('t.type =?', 2)
            ->andwhere('t.root_type != ?',3)
            ->orderBy('t.hits DESC,t.id DESC')
            ->limit($limit);
        if($id) $objs = $objs->addwhere("t.{$type} = ?",$id);
        if($day) $objs = $objs->andWhere('t.publish_date>= ?',date('Y-m-d H:i:s', strtotime("-$day day")));
        if($is_audit) {
            $objs->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        $objs = $objs->execute();

        $items = array();
        foreach ($objs as $re) {
            $items[] = array(
                'id' => $re->getId(),
                'title' => $re->getTitle(),
                'price' => $re->getPrice(),
                'img_url' => $re->getImgPath(),
                'root_type'=>(int)$re->getRootType(),
            );
        }

        return $items;
    }


    /*最新的海淘信息*/
    public function getNewHaitaoNews($limit,$page = 1,$root_id = null,$not_id = null, $isDaigou = false,$isArr = true,$is_audit = true){
        $page = $page ? $page -1 : 0;
        $objs = self::getInstance()->createQuery('t')
            ->where('type = 2')
            ->andwhere('is_delete = 0')
            //->andWhere('t.publish_date <= ?',date('Y-m-d H:i:s',time()))
            ->orderBy("publish_date DESC")
            ->limit($limit)
            ->offset($limit*$page);
        if($is_audit) {
            $objs->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        if($not_id) $objs = $objs->andWhere("id not in (" . join(",", $not_id) . ") ");
        if($isDaigou) $objs = $objs->andwhere('product_id != 0 and product_id != null');
        if($root_id) $objs = $objs->andwhere('root_id = ?',$root_id);

        $objs = $objs->execute();

        if($isArr){
            $items = array();
            foreach ($objs as $re) {
                $items[] = array(
                    'id' => $re->getId(),
                    'title' => $re->getTitle(),
                    'subtitle'=>$re->getSubtitle(),
                    'intro' => $re->getIntro(),
                    'price' => $re->getPrice(),
                    'img_url' => $re->getImgPath(),
                    'created_at' => $re->getPublishDate(),                               //创建时间用发布时间
                    'root_type'=>(int)$re->getRootType(),
                    'is_daigou'=>$re->getDaigouFlag(),                                   //是否是可以代购
                    'product_id'=>$re->getProductId(),
                );
            }
            return $items;
        }else{
            return $objs;
        }
    }

    /*================================识货app调用接口========================================*/
    public static function getYouhuiNewsToApp($page = 1,$page_size = 10,$root_id, $children_id, $type, $zhiding_id,$platform = 'android',$is_shopping = false, $order = 'default',$is_audit = true, $date = ''){


        if (($platform == 'androidHD' || $platform == 'iphoneHD') && $page > 1 && !empty($zhiding_id) && empty($root_id) && empty($children_id)){
            $offset = ($page - 1) * $page_size - 1;
        } else {
            $offset = ($page - 1) * $page_size;
        }
        $query =  self::getInstance()->createQuery('t')
            ->where('t.is_delete = 0')
            ->limit($page_size);

        if ($date) {
            $query->andWhere('t.publish_date < ?' , date('Y-m-d H:i:s', $date));
        } else {
            $query = $query->offset($offset);
        }

        if ($order == 'hot') {
            $query = $query->orderBy('t.rank desc');
        } else {
            $query = $query->orderBy('t.publish_date desc, t.id desc, t.hits desc');
        }

        if ($is_shopping) $query = $query->andWhere('t.is_shopping = ?',$is_shopping);
        if ($root_id) $query = $query->andWhere('t.root_id = ?',$root_id);
        if ($children_id) $query = $query->andWhere('t.children_id = ?',$children_id);
        if (empty($root_id) && empty($children_id) && !empty($zhiding_id)) $query = $query->andWhere('t.id != ?',$zhiding_id);
        if ($type){
            $query = $query->andWhere('t.type = ?',$type);
        } else {
            $query = $query->andWhere('t.is_display_index = ?',1);
        }
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return  $query->execute();
    }


    /*================================识货新版app调用接口========================================*/
    public static  function getNewsToApp($page,$page_size,$root_id, $children_id, $type,$sort="new",$is_audit = true)
    {
        $offset = ($page - 1) * $page_size;

        $query =  self::getInstance()->createQuery('t')
            ->where('t.is_delete = 0')
            //->andWhere('t.publish_date <= ?',date('Y-m-d H:i:s',time()))
            ->offset($offset)
            ->limit($page_size);

        if($sort == "new")
        {
           $query->orderBy('t.publish_date desc, t.id desc, t.hits desc');
        }

        if($sort == "hot")
        {
            $query->orderBy('t.rank desc, t.publish_date desc');
        }

        if ($root_id)
        {
            $query->andWhere('t.root_id = ?',$root_id);
        }

        if($children_id)
        {
            $query->andWhere('t.children_id = ?',$children_id);
        }

        if ($type)
        {
            $query->andWhere('t.type = ?',$type);
        }
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }

        return  $query->execute();
    }

    public static function getNewById($id,$is_audit = true)
    {
       $query =  self::getInstance()
                ->createQuery('t')
                ->addwhere('is_delete = 0')
                ->andWhere('t.id = ?',$id);
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        $query = $query->execute();

        if(count($query)>0)
        {
            return $query[0];
        }else{
            return null;
        }
    }

    public static function getNewByIdFromApp($id, $is_audit = true)
    {
        $query =  self::getInstance()
            ->createQuery('t')
            ->andWhere('t.id = ?',$id);
        if($is_audit) {
            $query->andWhere('t.audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        $query = $query->execute();
        if(count($query)>0)
        {
            return $query[0];
        }else{
            return null;
        }
    }

    public function getNewsByIds($ids,$is_audit = true)
    {
        if (empty($ids)) {
            return array();
        }
        $query =  $this->createQuery()
            ->where('id IN (' . join(',', $ids) . ')')
            ->addWhere('is_delete = 0')
            ->orderBy('rank DESC');
        if($is_audit) {
            $query->andWhere('audit_status in ('.self::$ALL_SUCC_AUDIT.')');
        }
        return $query->execute();
    }

    //TODO:: For SearchService服务化
    public function getObjByIds($ids)
    {
        if (empty($ids)) {
            return array();
        }
        $query =  $this->createQuery()
            ->where('id IN (' . join(',', $ids) . ')')
            ->orderBy("FIELD(`ID`,".trim(join(",", $ids)) . ')');
        return $query->execute();
    }

    /**
     * M站首页获取每日优惠
     * @return mixed
     */
    public function getNewsToHome()
    {
        //return array();
        $query =  self::getInstance()->createQuery('t')
            ->select('t.id,t.img_path,t.img_link,t.title,t.subtitle,t.publish_date,t.orginal_type')
            ->where('t.is_delete = 0')
            ->andwhere('t.audit_status  in ('.self::$ALL_SUCC_AUDIT.')')
            //->andWhere('t.publish_date <= ?',date('Y-m-d H:i:s',time()))
            ->limit(10)
            ->orderBy('t.publish_date desc, t.id desc, t.hits desc');
        return $query->execute();
    }

}